<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WDW Magic Explorer</title>
  <meta id="viewport-meta" name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#23287b">
  <meta property="og:title" content="WDW Magic Explorer">
  <meta property="og:description" content="Explore historical Disney World maps with custom overlays.">
  <meta property="og:image" content="icon-512.png">
  <meta property="og:type" content="website">
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior: none; overflow: hidden; font-family: Arial, Helvetica, sans-serif; }
    #map { width: 100vw; height: 100vh; touch-action: none; -webkit-user-select: none; user-select: none; }
    button, .ol-control-inner, #date-btn-inner, #quick-switch-btn, #roads-btn, #findme-btn { touch-action: manipulation; }
    .control-row { position: absolute; top: 8px; right: 8px; display: flex; flex-direction: row; align-items: center; z-index: 1100; gap: 0px; }
    .ol-control.custom-btn { position: static; padding: 0; border: none; background: none; box-shadow: none; outline: none; margin-bottom: 0; }
    #toggle-btn { margin: 0; }
    #roads-btn { position: absolute; right: 8px; top: 56px; z-index: 1000; }
    #findme-btn { position: absolute; right: 8px; top: 104px; z-index: 1000; }
    .ol-control-inner, #quick-switch-btn { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(255,255,255,0.85); border: 1.5px solid #ccc; border-radius: 8px; font-size: 15px; color: #222; cursor: pointer; transition: background 0.2s, border 0.2s; user-select: none; padding: 0; font-family: Arial, Helvetica, sans-serif; }
    .ol-control-inner img, #quick-switch-btn img { width: 24px; height: 24px; display: block; pointer-events: none; user-select: none; }
    .ol-control-inner:active, .ol-control-inner:focus, .ol-control-inner:hover, #quick-switch-btn:active, #quick-switch-btn:focus, #quick-switch-btn:hover { background: #f8f8f8; border-color: #999; }
    .ol-rotate { top: 80px !important; left: 8px !important; right: auto !important; }
    #logo { position: absolute; left: 16px; bottom: 16px; z-index: 1200; pointer-events: auto; opacity: 0.93; cursor: pointer; }
    #logo img { display: block; width: 200px; height: 36px; max-width: 98vw; }
    #findme-message { display: none; position: absolute; top: 16px; left: 50%; transform: translateX(-50%); z-index: 2000; background: rgba(255,255,255,0.92); color: #d62525; font-size: 17px; font-family: Arial, Helvetica, sans-serif; font-weight: bold; text-align: center; opacity: 0; padding: 7px 20px; border-radius: 16px; box-shadow: 0 2px 8px #0001; transition: opacity 0.4s; pointer-events: none; }
    #date-btn { margin-right: 7px; padding: 0; border: none; background: none; outline: none; font-family: Arial, Helvetica, sans-serif; cursor: pointer; }
    .hide-date-btn { display: none !important; }
    #date-btn-inner { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(255,255,255,0.85); border: 1.5px solid #ccc; border-radius: 8px; font-size: 15px; color: #222; cursor: pointer; font-family: Arial, Helvetica, sans-serif; }
    #date-btn-inner:active, #date-btn-inner:focus, #date-btn-inner:focus { background: #f8f8f8; border-color: #999; }
    #date-btn-inner img { width: 22px; height: 22px; }
    #date-popup { display: none; opacity: 0; position: absolute; right: 0; top: 48px; min-width: 180px; max-height: 70vh; overflow-y: auto; background: rgba(255,255,255,0.96); border: 1.5px solid #ccc; border-radius: 8px; box-shadow: 0 3px 15px #0002; z-index: 1400; font-family: Arial, Helvetica, sans-serif; }
    .date-popup-item { display: block; width: 100%; border: none; background: none; font-size: 15px; text-align: left; padding: 9px 16px; cursor: pointer; font-family: Arial, Helvetica, sans-serif; }
    .date-popup-item.selected { background: #f2f5fa; color: #3761c4; font-weight: bold; }
    .date-popup-item:active, .date-popup-item:hover { background: #f8f8f8; }
    #current-date-display { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1500; background: none; color: #fff; font-size: 22px; font-family: Arial, Helvetica, sans-serif; font-weight: bold; text-shadow: 0 3px 16px #222, 0 1px 0 #222; pointer-events: none; opacity: 0.97; padding: 0 22px; }
    #quick-switch-btn { position: absolute; bottom: calc(18px + env(safe-area-inset-bottom, 0)); right: 16px; z-index: 1300; display: none; font-family: Arial, Helvetica, sans-serif; width: 40px; height: 40px; border-radius: 8px; background: rgba(255,255,255,0.90); border: 1.5px solid #ccc; box-shadow: 0 3px 15px #0002; justify-content: center; align-items: center; color: #23287b; padding: 0; cursor: pointer; }
    #quick-switch-btn:active, #quick-switch-btn:focus, #quick-switch-btn:hover { background: #f8f8f8; border-color: #999; }
    #quick-switch-btn img { width: 24px; height: 24px; }
    @media (max-width: 600px) {
      .control-row { right: 8px; top: 8px; gap: 6px; }
      #date-btn { margin-right: 0; }
      #roads-btn { top: 48px; }
      #findme-btn { top: 88px; }
      .ol-control-inner, #date-btn-inner, #quick-switch-btn { width: 32px; height: 32px; border-radius: 6px; font-size: 13px; }
      .ol-control-inner img, #date-btn-inner img, #quick-switch-btn img { width: 18px; height: 18px; }
      #logo { left: 50%; transform: translateX(-50%); bottom: 8px;}
      #logo img { width: 180px !important; height: 32px !important; }
      #current-date-display { font-size: 16px; padding: 0 10px; top: 10px; }
      #quick-switch-btn { bottom: calc(8px + env(safe-area-inset-bottom, 0)); right: 8px; }
      #date-popup { min-width: 140px; max-height: 50vh; top: 40px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="control-row">
    <button id="date-btn" type="button">
      <span id="date-btn-inner" class="ol-control-inner">
        <img src="icons/calendar.svg" alt="Date Selector">
      </span>
    </button>
    <div id="date-popup"></div>
    <button id="toggle-btn" class="ol-control custom-btn">
      <span class="ol-control-inner" id="toggle-icon">
        <img src="icons/satellite.svg" alt="Satellite">
      </span>
    </button>
  </div>
  <button id="roads-btn" class="ol-control custom-btn">
    <span class="ol-control-inner" id="roads-icon">
      <img src="icons/roads.svg" alt="Roads">
    </span>
  </button>
  <button id="findme-btn" class="ol-control custom-btn">
    <span class="ol-control-inner" id="findme-icon">
      <img src="icons/locateme.svg" alt="Locate Me">
    </span>
  </button>
  <div id="findme-message"></div>
  <button id="quick-switch-btn" title="Quick Switch Dates" class="ol-control-inner">
    <img src="icons/switch.svg" alt="Switch">
  </button>
  <div id="logo">
    <img src="logo.svg" alt="WDW Magic Explorer Logo">
  </div>
  <div id="current-date-display"></div>
  <div id="disclaimer-modal">
    <div id="disclaimer-content">
      <h3>About</h3>
      <p>
        <strong>WDW Magic Explorer</strong> is a fan-made tool for viewing and comparing historical and current map imagery for Walt Disney World in Florida.<br>
        Easily switch between official Disney park maps from different years and ESRI Wayback satellite imagery. Features include date switching, user location, and fast map view switching for exploration and research.<br>
        <br>
        Made for Disney fans and anyone curious about how the parks have changed over time.
      </p>
      <a id="coffee-link" href="https://paypal.me/AshJB" target="_blank">â˜• Buy me a Coffee</a>
      <p>
        Created by Ashley Burton.<br>
        <br>
        <strong>Legal & Notices</strong><br>
        This is an independent, non-commercial project and is not affiliated with, endorsed by, or connected to The Walt Disney Company.<br>
        All map imagery &copy; Disney or their respective owners.<br>
        <br>
        ESRI World Imagery Wayback &copy; Esri, Maxar, Earthstar Geographics, and the GIS User Community.
      </p>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
  <script>
    // Bounding box for Walt Disney World in Web Mercator
    var disneyWorldExtent = ol.proj.transformExtent(
      [-81.9200, 28.1772, -81.2244, 28.6390],
      'EPSG:4326', 'EPSG:3857'
    );

    let servers = [];
    let disneyLayer, esriLayer, googleRoadsLayer, map;
    let dateBtn, dateBtnInner, datePopup, currentDateDisplay, quickSwitchBtn;
    let currentMode = 'disney'; // or 'sat'
    let currentIdx = 0; // index in servers array
    let lastTwoDisneyIdxs = [0, null];
    let lastTwoSatIdxs = [0, null];
    let roadsOn = false;

    // Fetch servers2.json
    fetch('servers2.json')
      .then(res => res.json())
      .then(json => {
        servers = json;
        initMap();
        setupUI();
        updateDateUI();
      }).catch(err => {
        alert('Failed to load servers2.json: ' + err);
      });

    function disneyTileUrl(server) {
      // NOTE: Replace below with your Disney tile URL pattern.
      // The 'code' is used in the path, adjust to match your backend or CDN setup.
      return `https://cdn6.parksmedia.wdprapps.disney.com/media/maps/prod/${server.code}/{z}/{x}/{y}.jpg`;
    }

    function esriTileUrl(server) {
      // Waybackdev is used here; for prod, change to wayback.maptiles.arcgis.com if needed.
      return `https://waybackdev.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/WMTS/1.0.0/default028mm/MapServer/tile/${server.esri_id}/{z}/{y}/{x}`;
    }

    function makeDisneyLayer(server) {
      return new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: disneyTileUrl(server),
          minZoom: 0, maxZoom: 20
        }),
        visible: currentMode === 'disney'
      });
    }

    function makeEsriLayer(server) {
      return new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: esriTileUrl(server),
          minZoom: 0, maxZoom: 20
        }),
        visible: currentMode === 'sat'
      });
    }

    function makeRoadsLayer() {
      // Using Google Roads overlay (open access, but may be subject to usage limits)
      return new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: 'https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}',
          minZoom: 0, maxZoom: 20
        }),
        visible: false, opacity: 0.85
      });
    }

    function initMap() {
      disneyLayer = makeDisneyLayer(servers[currentIdx]);
      esriLayer = makeEsriLayer(servers[currentIdx]);
      googleRoadsLayer = makeRoadsLayer();

      [disneyLayer, esriLayer, googleRoadsLayer].forEach(layer => {
        layer.getSource().set('extent', disneyWorldExtent);
      });

      map = new ol.Map({
        target: 'map',
        layers: [disneyLayer, esriLayer, googleRoadsLayer],
        view: new ol.View({
          center: ol.proj.fromLonLat([-81.5494, 28.3747]),
          zoom: 16,
          minZoom: 0, maxZoom: 20,
          extent: disneyWorldExtent
        })
      });

      // Only show current layer
      disneyLayer.setVisible(currentMode === 'disney');
      esriLayer.setVisible(currentMode === 'sat');
    }

    function setupUI() {
      dateBtn = document.getElementById('date-btn');
      dateBtnInner = document.getElementById('date-btn-inner');
      datePopup = document.getElementById('date-popup');
      currentDateDisplay = document.getElementById('current-date-display');
      quickSwitchBtn = document.getElementById('quick-switch-btn');

      // Date popup
      function fillDatePopup(selectedIdx) {
        datePopup.innerHTML = '';
        servers.forEach((srv, idx) => {
          var btn = document.createElement('button');
          btn.className = 'date-popup-item' + (idx === selectedIdx ? ' selected' : '');
          btn.textContent = srv.label;
          btn.onclick = function() {
            setDateIdx(idx);
            hideDatePopup();
          };
          datePopup.appendChild(btn);
        });
      }
      function showDatePopup() {
        fillDatePopup(currentIdx);
        datePopup.style.display = 'block';
        setTimeout(() => { datePopup.style.opacity = '1'; }, 10);
        setTimeout(() => {
          document.addEventListener('mousedown', hideOnOutside, { once: true });
          document.addEventListener('touchstart', hideOnOutside, { once: true });
        }, 0);
      }
      function hideOnOutside(e) {
        if (!datePopup.contains(e.target) && !dateBtn.contains(e.target)) hideDatePopup();
      }
      function hideDatePopup() {
        datePopup.style.opacity = '0';
        setTimeout(() => { datePopup.style.display = 'none'; }, 180);
      }
      dateBtn.onclick = function() {
        if (datePopup.style.display === 'block') {
          hideDatePopup();
        } else {
          showDatePopup();
        }
      };

      function setDateIdx(idx) {
        if (currentIdx === idx) return;
        if (currentMode === 'disney') {
          if (lastTwoDisneyIdxs[0] !== idx) lastTwoDisneyIdxs = [idx, lastTwoDisneyIdxs[0]];
        } else {
          if (lastTwoSatIdxs[0] !== idx) lastTwoSatIdxs = [idx, lastTwoSatIdxs[0]];
        }
        currentIdx = idx;
        updateLayers();
        updateDateUI();
      }

      // Toggle between Disney map and Satellite (ESRI)
      var showingDisney = true;
      document.getElementById('toggle-btn').onclick = function() {
        showingDisney = !showingDisney;
        currentMode = showingDisney ? 'disney' : 'sat';
        updateLayers();
        updateDateUI();
        document.getElementById('toggle-icon').querySelector('img').src =
          showingDisney ? 'icons/satellite.svg' : 'icons/mouse.svg';
        document.getElementById('toggle-icon').querySelector('img').alt =
          showingDisney ? 'Satellite' : 'Disney Map';
      };

      // Quick Switch button logic
      quickSwitchBtn.onclick = function() {
        let idxs = currentMode === 'disney' ? lastTwoDisneyIdxs : lastTwoSatIdxs;
        if (idxs[1] !== null) {
          setDateIdx(idxs[1]);
        }
      };

      // Roads button logic
      document.getElementById('roads-btn').onclick = function() {
        roadsOn = !roadsOn;
        document.getElementById('roads-icon').querySelector('img').src =
          roadsOn ? 'icons/no_roads.svg' : 'icons/roads.svg';
        document.getElementById('roads-icon').querySelector('img').alt =
          roadsOn ? 'No Roads' : 'Roads';
        googleRoadsLayer.setVisible(roadsOn);
      };

      // FIND ME button
      var findmeBtn = document.getElementById('findme-btn');
      var findmeMessage = document.getElementById('findme-message');
      var userLocationLayer = null;

      findmeBtn.onclick = function() {
        if (!navigator.geolocation) { showFindMeMessage('Geolocation not supported'); return; }
        navigator.geolocation.getCurrentPosition(function(pos) {
          var coords = [pos.coords.longitude, pos.coords.latitude];
          var projected = ol.proj.fromLonLat(coords);
          var within = ol.extent.containsCoordinate(disneyWorldExtent, projected);
          if (!within) { showFindMeMessage('Outside of WDW'); removeUserLocation(); return; }
          removeUserLocation();
          userLocationLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
              features: [new ol.Feature({geometry: new ol.geom.Point(projected)})]
            }),
            style: new ol.style.Style({
              image: new ol.style.Circle({
                radius: 10, fill: new ol.style.Fill({color: 'rgba(0,116,217,0.35)'}),
                stroke: new ol.style.Stroke({color: '#0074d9', width: 3})
              })
            }),
            zIndex: 99
          });
          map.addLayer(userLocationLayer);
          map.getView().animate({center: projected, zoom: 17, duration: 800});
        }, function(error) {
          showFindMeMessage('Unable to get location');
        }, { enableHighAccuracy: true });
      };

      function showFindMeMessage(msg) {
        findmeMessage.textContent = msg;
        findmeMessage.style.display = 'block';
        setTimeout(function() { findmeMessage.style.opacity = '1'; }, 10);
        setTimeout(function() {
          findmeMessage.style.opacity = '0';
          setTimeout(function() { findmeMessage.style.display = 'none'; }, 400);
        }, 2200);
      }
      function removeUserLocation() {
        if (userLocationLayer) {
          map.removeLayer(userLocationLayer);
          userLocationLayer = null;
        }
      }
    }

    function updateLayers() {
      // Remove old Disney/ESRI layers
      map.removeLayer(disneyLayer);
      map.removeLayer(esriLayer);

      // Re-create layers for new date
      disneyLayer = makeDisneyLayer(servers[currentIdx]);
      esriLayer = makeEsriLayer(servers[currentIdx]);
      disneyLayer.getSource().set('extent', disneyWorldExtent);
      esriLayer.getSource().set('extent', disneyWorldExtent);

      map.getLayers().insertAt(0, currentMode === 'disney' ? disneyLayer : esriLayer);

      // Set visibility
      disneyLayer.setVisible(currentMode === 'disney');
      esriLayer.setVisible(currentMode === 'sat');
    }

    function updateDateUI() {
      // Date label
      currentDateDisplay.textContent = servers[currentIdx].label;
      currentDateDisplay.style.display = 'block';

      // Show quick switch button if a previous exists
      let idxs = currentMode === 'disney' ? lastTwoDisneyIdxs : lastTwoSatIdxs;
      quickSwitchBtn.style.display = idxs[1] !== null ? 'flex' : 'none';
    }

    // About modal logic (no close button)
    const logo = document.getElementById('logo');
    const disclaimerModal = document.getElementById('disclaimer-modal');
    if (logo && disclaimerModal) {
      logo.style.cursor = 'pointer';
      logo.onclick = function() {
        disclaimerModal.classList.add('active');
      };
      disclaimerModal.onclick = function(e) {
        if (e.target === disclaimerModal) {
          disclaimerModal.classList.remove('active');
        }
      };
    }
  </script>
</body>
</html>
