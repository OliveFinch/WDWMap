<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WDW Magic Explorer (Grouped Buttons Test)</title>
  <meta id="viewport-meta" name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#23287b">
  <meta property="og:title" content="WDW Magic Explorer">
  <meta property="og:description" content="Explore historical Disney World maps with custom overlays.">
  <meta property="og:image" content="icon-512.png">
  <meta property="og:type" content="website">
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior: none; overflow: hidden; font-family: Arial, Helvetica, sans-serif;}
    #map { width: 100vw; height: 100vh; touch-action: none; -webkit-user-select: none; user-select: none; }

    /* Keep the original button visual style */
    .ol-control-inner, .btn-square { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(255,255,255,0.85); border: 1.5px solid #ccc; border-radius: 8px; font-size: 15px; color: #222; cursor: pointer; transition: background 0.2s, border 0.2s; user-select: none; padding: 0; font-family: Arial, Helvetica, sans-serif; }
    .ol-control-inner img, .btn-square img { width: 24px; height: 24px; display: block; pointer-events: none; user-select: none; }
    .ol-control-inner:active, .ol-control-inner:focus, .ol-control-inner:hover,
    .btn-square:active, .btn-square:focus, .btn-square:hover { background: #f8f8f8; border-color: #999;}

    /* Group containers */
    .group-top-right { position: absolute; top: 8px; right: 8px; display: flex; flex-direction: column; gap: 8px; z-index: 1100; }
    .group-bottom-right { position: absolute; right: 8px; bottom: calc(18px + env(safe-area-inset-bottom, 0)); display: flex; flex-direction: column; gap: 8px; z-index: 1100; }
    .group-top-left { position: absolute; top: 8px; left: 56px; display: flex; flex-direction: column; gap: 8px; z-index: 1100; }

    /* Popup menus */
    #date-popup, #left-date-popup { display: none; opacity: 0; position: absolute; min-width: 180px; max-height: 70vh; overflow-y: auto; background: rgba(255,255,255,0.96); border: 1.5px solid #ccc; border-radius: 8px; box-shadow: 0 3px 15px #0002; z-index: 1400; font-family: Arial, Helvetica, sans-serif; }
    #date-popup { right: 8px; top: 56px; }
    #left-date-popup { left: 56px; top: 56px; }
    .date-popup-item { display: block; width: 100%; border: none; background: none; font-size: 15px; text-align: left; padding: 9px 16px; cursor: pointer; font-family: Arial, Helvetica, sans-serif; }
    .date-popup-item.selected { background: #f2f5fa; color: #3761c4; font-weight: bold;}
    .date-popup-item:active, .date-popup-item:hover { background: #f8f8f8;}

    #current-date-display { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1500; background: none; color: #fff; font-size: 22px; font-weight: bold; text-shadow: 0 3px 16px #222, 0 1px 0 #222; pointer-events: none; opacity: 0.97; padding: 0 22px;}

    #logo { position: absolute; left: 16px; bottom: 16px; z-index: 1200; pointer-events: auto; opacity: 0.93; cursor: pointer;}
    #logo img { display: block; width: 200px; height: 36px; max-width: 98vw;}

    #findme-message { display: none; position: absolute; top: 16px; left: 50%; transform: translateX(-50%); z-index: 2000; background: rgba(255,255,255,0.92); color: #d62525; font-size: 17px; font-weight: bold; text-align: center; opacity: 0; padding: 7px 20px; border-radius: 16px; box-shadow: 0 2px 8px #0001; transition: opacity 0.4s; pointer-events: none;}

    /* Hide-by-default buttons (logic will toggle) */
    #compare-btn, #highlight-btn, #left-date-btn { display: none; }

    @media (max-width: 600px) {
      .group-top-right { right: 8px; top: 8px; gap: 6px; }
      .group-bottom-right { right: 8px; bottom: calc(8px + env(safe-area-inset-bottom, 0)); gap: 6px; }
      .group-top-left { left: 50px; top: 8px; gap: 6px; }
      .ol-control-inner, .btn-square { width: 32px; height: 32px; border-radius: 6px; font-size: 13px; }
      .ol-control-inner img, .btn-square img { width: 18px; height: 18px; }
      #logo { left: 50%; transform: translateX(-50%); bottom: 8px;}
      #logo img { width: 180px !important; height: 32px !important; }
      #current-date-display { font-size: 16px; padding: 0 10px; top: 10px; }
      #date-popup { min-width: 140px; max-height: 50vh; top: 44px; right: 8px; }
      #left-date-popup { min-width: 140px; max-height: 50vh; top: 44px; left: 50px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- TOP-RIGHT GROUP: Date, Toggle, Compare, Highlight -->
  <div class="group-top-right" id="grp-top-right">
    <button id="date-btn" type="button" class="btn-square" title="Choose date">
      <img src="icons/calendar.svg" alt="Date Selector">
    </button>
    <button id="toggle-btn" class="btn-square" title="Switch Disney/Satellite">
      <img id="toggle-icon-img" src="icons/satellite.svg" alt="Satellite">
    </button>
    <button id="compare-btn" class="btn-square" title="Compare Mode">
      <img src="icons/compare.svg" alt="Compare">
    </button>
    <button id="highlight-btn" class="btn-square" title="Highlight Changes">
      <img src="icons/highlight.svg" alt="Highlight">
    </button>
  </div>

  <!-- POPUP for right-side date picker -->
  <div id="date-popup"></div>

  <!-- TOP-LEFT GROUP: Left-date calendar (shown only in compare mode)  -->
  <div class="group-top-left" id="grp-top-left">
    <button id="left-date-btn" type="button" class="btn-square" title="Choose left date">
      <img src="icons/calendar.svg" alt="Left Date Selector">
    </button>
  </div>
  <div id="left-date-popup"></div>

  <!-- BOTTOM-RIGHT GROUP: Locate Me, Roads, Quick Switch -->
  <div class="group-bottom-right" id="grp-bottom-right">
    <button id="findme-btn" class="btn-square" title="Locate Me">
      <img src="icons/locateme.svg" alt="Locate Me">
    </button>
    <button id="roads-btn" class="btn-square" title="Roads overlay">
      <img id="roads-icon-img" src="icons/roads.svg" alt="Roads">
    </button>
    <button id="quick-switch-btn" title="Quick Switch Dates" class="btn-square" style="display:none;">
      <img src="icons/switch.svg" alt="Switch">
    </button>
  </div>

  <div id="findme-message"></div>
  <div id="logo"><img src="logo.svg" alt="WDW Magic Explorer Logo"></div>
  <div id="current-date-display"></div>

  <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
  <script>
    // Wrap everything in an IIFE to avoid polluting the global scope and prevent
    // duplicate variable declaration errors across multiple script files.
    (function() {
      'use strict';

      // ===== App State =====
      let serverOptions = [];
      let disneyServer = null; // current chosen date code
      let lastTwoDates = [null, null];
      let showingDisney = true;
      let compareMode = false; // UI only â€” hook your actual compare impl here
      let highlightMode = false;
      let roadsOn = false;

      // Map & layers
      let map, disneyLayer, esriLayer, roadsLayer;

      // Controls
      const dateBtn = document.getElementById('date-btn');
      const datePopup = document.getElementById('date-popup');
      const leftDateBtn = document.getElementById('left-date-btn');
      const leftDatePopup = document.getElementById('left-date-popup');
      const toggleBtn = document.getElementById('toggle-btn');
      const toggleIconImg = document.getElementById('toggle-icon-img');
      const compareBtn = document.getElementById('compare-btn');
      const highlightBtn = document.getElementById('highlight-btn');
      const quickSwitchBtn = document.getElementById('quick-switch-btn');
      const roadsBtn = document.getElementById('roads-btn');
      const roadsIconImg = document.getElementById('roads-icon-img');
      const findmeBtn = document.getElementById('findme-btn');
      const currentDateDisplay = document.getElementById('current-date-display');

      // Extent bounds
      const disneyWorldExtent = ol.proj.transformExtent(
        [-81.9200, 28.1772, -81.2244, 28.6390], 'EPSG:4326', 'EPSG:3857'
      );

      // Utility lookups
      function getLabelForCode(code) {
        const rec = serverOptions.find(o => o.code === code);
        return rec ? rec.label : '';
      }
      function getEsriIdForCode(code) {
        const rec = serverOptions.find(o => o.code === code);
        return rec && rec.esri_id ? rec.esri_id : '';
      }
      function getEsriLabelForCode(code) {
        const rec = serverOptions.find(o => o.code === code);
        return rec && rec.esri_label ? rec.esri_label : '';
      }

      // Layers
      function makeDisneyLayer(server) {
        return new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: `https://cdn6.parksmedia.wdprapps.disney.com/media/maps/prod/${server}/{z}/{x}/{y}.jpg`,
            minZoom: 0, maxZoom: 20
          }),
          visible: true
        });
      }
      function makeEsriLayer(esri_id) {
        if (!esri_id) return null;
        const lyr = new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: `https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/WMTS/1.0.0/default028mm/MapServer/tile/${esri_id}/{z}/{y}/{x}`,
            minZoom: 0, maxZoom: 20
          }),
          visible: false
        });
        lyr.set('esri_id', esri_id);
        return lyr;
      }
      function makeRoadsLayer() {
        return new ol.layer.Tile({
          source: new ol.source.XYZ({ url: 'https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}', minZoom: 0, maxZoom: 20 }),
          visible: false, opacity: 0.85
        });
      }

      function setRoadsLayerState() {
        if (!roadsLayer) return;
        roadsLayer.setVisible(roadsOn);
        const layers = map.getLayers();
        if (layers.getArray()[layers.getLength()-1] !== roadsLayer) {
          map.removeLayer(roadsLayer); map.addLayer(roadsLayer);
        }
      }

      function onBaseLayerChange() { setRoadsLayerState(); }

      function initMap() {
        disneyLayer = makeDisneyLayer(disneyServer);
        esriLayer = makeEsriLayer(getEsriIdForCode(disneyServer));
        roadsLayer = makeRoadsLayer();
        disneyLayer.getSource().set('extent', disneyWorldExtent);
        if (esriLayer) esriLayer.getSource().set('extent', disneyWorldExtent);
        roadsLayer.getSource().set('extent', disneyWorldExtent);

        map = new ol.Map({
          target: 'map',
          layers: [disneyLayer, esriLayer, roadsLayer].filter(Boolean),
          view: new ol.View({
            center: ol.proj.fromLonLat([-81.5494, 28.3747]),
            zoom: 16, minZoom: 0, maxZoom: 20, extent: disneyWorldExtent
          })
        });
      }

      // ===== UI helpers =====
      function updateDateUI() {
        const isDisney = showingDisney;
        if (isDisney) {
          currentDateDisplay.textContent = getLabelForCode(disneyServer);
        } else {
          currentDateDisplay.textContent = getEsriLabelForCode(disneyServer) || (getLabelForCode(disneyServer) + ' (Satellite)');
        }
        currentDateDisplay.style.display = 'block';

        // Button visibility logic
        // Top-right: date (always), toggle (always), compare (only in Disney mode), highlight (only compare mode)
        compareBtn.style.display = (showingDisney ? 'flex' : 'none');
        highlightBtn.style.display = (showingDisney && compareMode ? 'flex' : 'none');
        // Left date button: only visible in compare mode
        leftDateBtn.style.display = (compareMode ? 'flex' : 'none');
        // Bottom-right quick switch visible if we have 2 dates in history
        quickSwitchBtn.style.display = (lastTwoDates[1] ? 'flex' : 'none');

        // Toggle icon imagery
        toggleIconImg.src = showingDisney ? 'icons/satellite.svg' : 'icons/mouse.svg';
        toggleIconImg.alt = showingDisney ? 'Satellite' : 'Disney Map';
      }

      function fillDatePopupFor(btnEl, popupEl, selectedCode) {
        popupEl.innerHTML = '';
        const reversed = serverOptions.slice().reverse();
        reversed.forEach(opt => {
          const b = document.createElement('button');
          b.className = 'date-popup-item' + (opt.code === selectedCode ? ' selected' : '');
          b.textContent = showingDisney ? opt.label : (opt.esri_label || opt.label);
          b.onclick = function() {
            setMapDate(opt.code);
            hidePopup(popupEl);
          };
          popupEl.appendChild(b);
        });
        // position already handled by CSS (anchored near corners)
      }
      function showPopup(popupEl) { popupEl.style.display = 'block'; setTimeout(()=> popupEl.style.opacity = '1', 10); }
      function hidePopup(popupEl) { popupEl.style.opacity = '0'; setTimeout(()=> popupEl.style.display = 'none', 180); }

      function setMapDate(newCode) {
        if (disneyServer === newCode) return;
        if (lastTwoDates[0] !== newCode) lastTwoDates = [newCode, lastTwoDates[0]];
        disneyServer = newCode;
        if (showingDisney) {
          const vis = disneyLayer.getVisible();
          map.removeLayer(disneyLayer);
          disneyLayer = makeDisneyLayer(newCode);
          disneyLayer.setVisible(vis);
          disneyLayer.getSource().set('extent', disneyWorldExtent);
          map.getLayers().setAt(0, disneyLayer);
        } else {
          const esri_id = getEsriIdForCode(newCode);
          const vis = esriLayer && esriLayer.getVisible();
          if (!esriLayer || esriLayer.get('esri_id') !== esri_id) {
            if (esriLayer) map.removeLayer(esriLayer);
            esriLayer = makeEsriLayer(esri_id);
            if (esriLayer) {
              esriLayer.set('esri_id', esri_id);
              esriLayer.getSource().set('extent', disneyWorldExtent);
              map.getLayers().setAt(1, esriLayer);
            }
          }
          if (esriLayer) esriLayer.setVisible(vis);
        }
        onBaseLayerChange();
        updateDateUI();
      }

      // ===== Events (menus & toggles) =====
      dateBtn.addEventListener('click', () => {
        if (datePopup.style.display === 'block') { hidePopup(datePopup); return; }
        fillDatePopupFor(dateBtn, datePopup, disneyServer);
        showPopup(datePopup);
        const hide = (e)=>{ if (!datePopup.contains(e.target) && e.target !== dateBtn && !dateBtn.contains(e.target)) { hidePopup(datePopup); document.removeEventListener('mousedown', hide, true); document.removeEventListener('touchstart', hide, true);} };
        setTimeout(()=>{ document.addEventListener('mousedown', hide, true); document.addEventListener('touchstart', hide, true); }, 0);
      });

      leftDateBtn.addEventListener('click', () => {
        if (leftDatePopup.style.display === 'block') { hidePopup(leftDatePopup); return; }
        // In your real compare mode, this would call your left-date setter; here we reuse setMapDate for demo
        fillDatePopupFor(leftDateBtn, leftDatePopup, disneyServer);
        showPopup(leftDatePopup);
        const hide = (e)=>{ if (!leftDatePopup.contains(e.target) && e.target !== leftDateBtn && !leftDateBtn.contains(e.target)) { hidePopup(leftDatePopup); document.removeEventListener('mousedown', hide, true); document.removeEventListener('touchstart', hide, true);} };
        setTimeout(()=>{ document.addEventListener('mousedown', hide, true); document.addEventListener('touchstart', hide, true); }, 0);
      });

      toggleBtn.addEventListener('click', () => {
        showingDisney = !showingDisney;
        if (showingDisney) {
          disneyLayer.setVisible(true);
          if (esriLayer) esriLayer.setVisible(false);
        } else {
          disneyLayer.setVisible(false);
          const esriId = getEsriIdForCode(disneyServer);
          if (!esriLayer || esriLayer.get('esri_id') !== esriId) {
            if (esriLayer) map.removeLayer(esriLayer);
            esriLayer = makeEsriLayer(esriId);
            if (esriLayer) {
              esriLayer.set('esri_id', esriId);
              esriLayer.getSource().set('extent', disneyWorldExtent);
              map.getLayers().setAt(1, esriLayer);
            }
          }
          if (esriLayer) esriLayer.setVisible(true);
        }
        onBaseLayerChange();
        updateDateUI();
      });

      compareBtn.addEventListener('click', () => {
        // Toggle compare mode UI state (hook into your existing compare code here)
        compareMode = !compareMode;
        if (!compareMode) { highlightMode = false; }
        updateDateUI();
      });

      highlightBtn.addEventListener('click', () => {
        // Only meaningful when compareMode is on
        if (!compareMode) return;
        highlightMode = !highlightMode;
        updateDateUI();
      });

      roadsBtn.addEventListener('click', () => {
        roadsOn = !roadsOn;
        roadsIconImg.src = roadsOn ? 'icons/no_roads.svg' : 'icons/roads.svg';
        roadsIconImg.alt = roadsOn ? 'No Roads' : 'Roads';
        setRoadsLayerState();
      });

      quickSwitchBtn.addEventListener('click', () => { if (lastTwoDates[1]) setMapDate(lastTwoDates[1]); });

      // Find Me button
      const findmeMessage = document.getElementById('findme-message');
      function showFindMeMessage(msg) {
        findmeMessage.textContent = msg; findmeMessage.style.display = 'block';
        setTimeout(()=> findmeMessage.style.opacity = '1', 10);
        setTimeout(()=> { findmeMessage.style.opacity = '0'; setTimeout(()=> findmeMessage.style.display = 'none', 400); }, 2200);
      }
      findmeBtn.addEventListener('click', () => {
        if (!navigator.geolocation) { showFindMeMessage('Geolocation not supported'); return; }
        navigator.geolocation.getCurrentPosition((pos)=>{
          const coords = [pos.coords.longitude, pos.coords.latitude];
          const projected = ol.proj.fromLonLat(coords);
          const within = ol.extent.containsCoordinate(disneyWorldExtent, projected);
          if (!within) { showFindMeMessage('Outside of WDW'); return; }
          const feature = new ol.Feature({ geometry: new ol.geom.Point(projected) });
          const layer = new ol.layer.Vector({
            source: new ol.source.Vector({ features: [feature] }),
            style: new ol.style.Style({ image: new ol.style.Circle({ radius: 10, fill: new ol.style.Fill({color: 'rgba(0,116,217,0.35)'}), stroke: new ol.style.Stroke({color: '#0074d9', width: 3}) }) }),
            zIndex: 99
          });
          map.addLayer(layer);
          map.getView().animate({ center: projected, zoom: 17, duration: 800 });
          setTimeout(()=> map.removeLayer(layer), 5000);
        }, ()=> showFindMeMessage('Unable to get location'), { enableHighAccuracy: true });
      });

      // Double-tap and hold zoom helper (kept from your app)
      (function() {
        let lastTap = 0, isHoldZoom = false, startY = 0, startZoom = 0, holdTimeout = null;
        const mapDiv = document.getElementById('map');
        function moveHandler(e) {
          if (!isHoldZoom || e.touches.length !== 1) return;
          e.preventDefault();
          const dy = e.touches[0].clientY - startY;
          const view = map.getView();
          let newZoom = startZoom - dy / 80; newZoom = Math.max(view.getMinZoom(), Math.min(view.getMaxZoom(), newZoom));
          view.setZoom(newZoom);
        }
        mapDiv.addEventListener('touchstart', function(e) {
          if (e.touches.length !== 1) return; const now = Date.now();
          if (now - lastTap < 350) { e.preventDefault(); startY = e.touches[0].clientY; startZoom = map.getView().getZoom(); isHoldZoom = true; holdTimeout = setTimeout(()=> mapDiv.addEventListener('touchmove', moveHandler, { passive: false }), 100); }
          else { lastTap = now; isHoldZoom = false; if (holdTimeout) clearTimeout(holdTimeout); }
        });
        mapDiv.addEventListener('touchend', function() { if (isHoldZoom) { isHoldZoom = false; mapDiv.removeEventListener('touchmove', moveHandler, { passive: false }); } if (holdTimeout) clearTimeout(holdTimeout); });
      })();

      // ===== Boot =====
      fetch('servers2.json')
        .then(r => r.json())
        .then(json => {
          serverOptions = json;
          disneyServer = serverOptions[serverOptions.length - 1].code;
          lastTwoDates = [disneyServer, null];
          initMap();
          updateDateUI();
        })
        .catch(err => alert('Failed to load servers2.json: ' + err));

      // ===== Lightweight self-tests (do not throw) =====
      console.assert(document.getElementById('grp-top-right'), 'Top-right group should exist');
      console.assert(document.getElementById('grp-bottom-right'), 'Bottom-right group should exist');
      console.assert(document.getElementById('date-btn'), 'Date button should exist');
      // Ensure this script did NOT leak variables globally (helps avoid duplicate identifier issues)
      console.assert(typeof window.quickSwitchBtn === 'undefined', 'quickSwitchBtn should not be global (scoped inside IIFE)');
    })();
  </script>
</body>
</html>
