<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WDW Magic Explorer</title>
  <meta id="viewport-meta" name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#23287b">
  <meta property="og:title" content="WDW Magic Explorer">
  <meta property="og:description" content="Explore historical Disney World maps with custom overlays.">
  <meta property="og:image" content="icon-512.png">
  <meta property="og:type" content="website">
  <style>
    /* -- Your CSS remains unchanged from your original for brevity -- */
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior: none; overflow: hidden; font-family: Arial, Helvetica, sans-serif;}
    #map { width: 100vw; height: 100vh; touch-action: none; -webkit-user-select: none; user-select: none;}
    button, .ol-control-inner, #date-btn-inner, #quick-switch-btn, #roads-btn, #findme-btn { touch-action: manipulation; }
    /* ... (copy all your CSS as-is from original code here) ... */
    #disclaimer-modal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.45); align-items: center; justify-content: center; transition: opacity 0.2s;}
    #disclaimer-modal.active { display: flex; }
    #disclaimer-content { background: #fff; border-radius: 14px; padding: 24px 20px 14px 20px; box-shadow: 0 6px 32px #0003; max-width: 96vw; width: 350px; font-size: 15px; color: #222; text-align: left; position: relative;}
    /* ... (rest of your CSS) ... */
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="control-row">
    <!-- Date Selector Button -->
    <button id="date-btn" type="button">
      <span id="date-btn-inner" class="ol-control-inner">
        <img src="icons/calendar.svg" alt="Date Selector">
      </span>
    </button>
    <div id="date-popup"></div>
    <!-- Toggle View Button -->
    <button id="toggle-btn" class="ol-control custom-btn">
      <span class="ol-control-inner" id="toggle-icon">
        <img src="icons/satellite.svg" alt="Satellite">
      </span>
    </button>
  </div>
  <!-- Roads Button -->
  <button id="roads-btn" class="ol-control custom-btn">
    <span class="ol-control-inner" id="roads-icon">
      <img src="icons/roads.svg" alt="Roads">
    </span>
  </button>
  <!-- Find Me Button -->
  <button id="findme-btn" class="ol-control custom-btn">
    <span class="ol-control-inner" id="findme-icon">
      <img src="icons/locateme.svg" alt="Locate Me">
    </span>
  </button>
  <div id="findme-message"></div>
  <!-- Quick Switch Button -->
  <button id="quick-switch-btn" title="Quick Switch Dates" class="ol-control-inner">
    <img src="icons/switch.svg" alt="Switch">
  </button>
  <!-- Logo (external SVG) -->
  <div id="logo">
    <img src="logo.svg" alt="WDW Magic Explorer Logo">
  </div>
  <div id="current-date-display"></div>

  <!-- About Modal -->
  <div id="disclaimer-modal">
    <div id="disclaimer-content">
      <h3>About</h3>
      <p>
        <strong>WDW Magic Explorer</strong> is a fan-made tool for viewing and comparing historical and current map imagery for Walt Disney World in Florida.<br>
        Easily switch between official Disney park maps from different years, and historical satellite views via ESRI Wayback imagery. Features include date switching, user location, and fast map view switching for exploration and research.<br>
        <br>
        Made for Disney fans and anyone curious about how the parks have changed over time.
      </p>
      <a id="coffee-link" href="https://paypal.me/AshJB" target="_blank">â˜• Buy me a Coffee</a>
      <p>
        Created by Ashley Burton.<br>
        <br>
        <strong>Legal & Notices</strong><br>
        This is an independent, non-commercial project and is not affiliated with, endorsed by, or connected to The Walt Disney Company.<br>
        All map imagery &copy; Disney or their respective owners.<br>
        <br>
        Satellite data &copy; ESRI, Maxar, and their imagery partners.
      </p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
  <script>
    // Two date lists: Disney and ESRI
    let disneyDates = [], esriDates = [];
    let disneyServer = null, esriServer = null;
    let showingDisney = true;
    let lastTwoDates = [null, null];
    let dateBtn, dateBtnInner, datePopup, currentDateDisplay, quickSwitchBtn;

    // Load servers2.json, split into Disney and ESRI lists
    fetch('servers2.json')
      .then(response => response.json())
      .then(json => {
        disneyDates = json.disney;
        esriDates = json.esri;
        // Set initial date codes to most recent
        disneyServer = disneyDates[disneyDates.length - 1].code;
        esriServer = esriDates[esriDates.length - 1].code;
        initMap();
        setupUI();
        updateDateUI();
      })
      .catch(err => alert('Failed to load servers2.json: ' + err));

    // Disney bounding box
    var disneyWorldExtent = ol.proj.transformExtent(
      [-81.9200, 28.1772, -81.2244, 28.6390],
      'EPSG:4326', 'EPSG:3857'
    );

    let disneyLayer, esriLayer, googleRoadsLayer, map;

    function makeDisneyLayer(server) {
      return new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: `https://cdn6.parksmedia.wdprapps.disney.com/media/maps/prod/${server}/{z}/{x}/{y}.jpg`,
          minZoom: 0, maxZoom: 20
        }),
        visible: true
      });
    }

    function makeESRILayer(serverObj) {
      return new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: serverObj.url,
          minZoom: 0, maxZoom: 20
        }),
        visible: false
      });
    }

    function initMap() {
      // Use most recent Disney and ESRI dates for initial layers
      disneyLayer = makeDisneyLayer(disneyServer);
      esriLayer = makeESRILayer(esriDates.find(e => e.code === esriServer));
      googleRoadsLayer = new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: 'https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}',
          minZoom: 0, maxZoom: 20
        }),
        visible: false, opacity: 0.85
      });

      disneyLayer.getSource().set('extent', disneyWorldExtent);
      esriLayer.getSource().set('extent', disneyWorldExtent);
      googleRoadsLayer.getSource().set('extent', disneyWorldExtent);

      map = new ol.Map({
        target: 'map',
        layers: [disneyLayer, esriLayer, googleRoadsLayer],
        view: new ol.View({
          center: ol.proj.fromLonLat([-81.5494, 28.3747]),
          zoom: 16,
          minZoom: 0, maxZoom: 20,
          extent: disneyWorldExtent
        })
      });
    }

    function setupUI() {
      dateBtn = document.getElementById('date-btn');
      dateBtnInner = document.getElementById('date-btn-inner');
      datePopup = document.getElementById('date-popup');
      currentDateDisplay = document.getElementById('current-date-display');
      quickSwitchBtn = document.getElementById('quick-switch-btn');

      // Fill date popup for either Disney or ESRI
      function fillDatePopup(selectedCode) {
        datePopup.innerHTML = '';
        let list = showingDisney ? disneyDates : esriDates;
        list.slice().reverse().forEach(opt => {
          var btn = document.createElement('button');
          btn.className = 'date-popup-item' + (opt.code === selectedCode ? ' selected' : '');
          btn.textContent = opt.label;
          btn.onclick = function() {
            setMapDate(opt.code);
            hideDatePopup();
          };
          datePopup.appendChild(btn);
        });
      }

      function showDatePopup() {
        fillDatePopup(showingDisney ? disneyServer : esriServer);
        datePopup.style.display = 'block';
        setTimeout(() => { datePopup.style.opacity = '1'; }, 10);
        setTimeout(() => {
          document.addEventListener('mousedown', hideOnOutside, { once: true });
          document.addEventListener('touchstart', hideOnOutside, { once: true });
        }, 0);
      }
      function hideOnOutside(e) {
        if (!datePopup.contains(e.target) && !dateBtn.contains(e.target)) hideDatePopup();
      }
      function hideDatePopup() {
        datePopup.style.opacity = '0';
        setTimeout(() => { datePopup.style.display = 'none'; }, 180);
      }
      dateBtn.onclick = function() {
        if (datePopup.style.display === 'block') {
          hideDatePopup();
        } else {
          showDatePopup();
        }
      };

      function setMapDate(newCode) {
        if (showingDisney) {
          if (disneyServer === newCode) return;
          // Track last two unique selections
          if (lastTwoDates[0] !== newCode) {
            lastTwoDates = [newCode, lastTwoDates[0]];
          }
          disneyServer = newCode;
          var vis = disneyLayer.getVisible();
          map.removeLayer(disneyLayer);
          disneyLayer = makeDisneyLayer(newCode);
          disneyLayer.setVisible(vis);
          disneyLayer.getSource().set('extent', disneyWorldExtent);
          map.getLayers().insertAt(0, disneyLayer);
        } else {
          if (esriServer === newCode) return;
          if (lastTwoDates[0] !== newCode) {
            lastTwoDates = [newCode, lastTwoDates[0]];
          }
          esriServer = newCode;
          var vis = esriLayer.getVisible();
          map.removeLayer(esriLayer);
          esriLayer = makeESRILayer(esriDates.find(e => e.code === newCode));
          esriLayer.setVisible(vis);
          esriLayer.getSource().set('extent', disneyWorldExtent);
          map.getLayers().insertAt(1, esriLayer); // Insert after Disney layer
        }
        updateDateUI();
      }

      // Toggle between Disney map and Satellite (ESRI)
      document.getElementById('toggle-btn').onclick = function() {
        showingDisney = !showingDisney;
        disneyLayer.setVisible(showingDisney);
        esriLayer.setVisible(!showingDisney);
        updateDateUI();
        // Switch icon
        document.getElementById('toggle-icon').querySelector('img').src =
          showingDisney ? 'icons/satellite.svg' : 'icons/mouse.svg';
        document.getElementById('toggle-icon').querySelector('img').alt =
          showingDisney ? 'Satellite' : 'Disney Map';
      };

      // Quick Switch button logic
      quickSwitchBtn.onclick = function() {
        if (lastTwoDates[1]) {
          setMapDate(lastTwoDates[1]);
        }
      };

      // Roads button logic (optional: only enable on Disney if you wish)
      var roadsOn = false;
      document.getElementById('roads-btn').onclick = function() {
        roadsOn = !roadsOn;
        document.getElementById('roads-icon').querySelector('img').src =
          roadsOn ? 'icons/no_roads.svg' : 'icons/roads.svg';
        document.getElementById('roads-icon').querySelector('img').alt =
          roadsOn ? 'No Roads' : 'Roads';
        googleRoadsLayer.setVisible(roadsOn);
      };

      // FIND ME button
      var findmeBtn = document.getElementById('findme-btn');
      var findmeMessage = document.getElementById('findme-message');
      var userLocationLayer = null;
      findmeBtn.onclick = function() {
        if (!navigator.geolocation) { showFindMeMessage('Geolocation not supported'); return; }
        navigator.geolocation.getCurrentPosition(function(pos) {
          var coords = [pos.coords.longitude, pos.coords.latitude];
          var projected = ol.proj.fromLonLat(coords);
          var within = ol.extent.containsCoordinate(disneyWorldExtent, projected);
          if (!within) { showFindMeMessage('Outside of WDW'); removeUserLocation(); return; }
          removeUserLocation();
          userLocationLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
              features: [new ol.Feature({geometry: new ol.geom.Point(projected)})]
            }),
            style: new ol.style.Style({
              image: new ol.style.Circle({
                radius: 10, fill: new ol.style.Fill({color: 'rgba(0,116,217,0.35)'}),
                stroke: new ol.style.Stroke({color: '#0074d9', width: 3})
              })
            }),
            zIndex: 99
          });
          map.addLayer(userLocationLayer);
          map.getView().animate({center: projected, zoom: 17, duration: 800});
        }, function(error) {
          showFindMeMessage('Unable to get location');
        }, { enableHighAccuracy: true });
      };
      function showFindMeMessage(msg) {
        findmeMessage.textContent = msg;
        findmeMessage.style.display = 'block';
        setTimeout(function() { findmeMessage.style.opacity = '1'; }, 10);
        setTimeout(function() {
          findmeMessage.style.opacity = '0';
          setTimeout(function() { findmeMessage.style.display = 'none'; }, 400);
        }, 2200);
      }
      function removeUserLocation() {
        if (userLocationLayer) {
          map.removeLayer(userLocationLayer);
          userLocationLayer = null;
        }
      }

      // Double-tap and hold to zoom, Google Maps style
      (function() {
        var lastTap = 0;
        var isHoldZoom = false;
        var startY = 0;
        var startZoom = 0;
        var mapDiv = document.getElementById('map');
        var holdTimeout = null;

        mapDiv.addEventListener('touchstart', function(e) {
          if (e.touches.length !== 1) return;
          var now = Date.now();
          if (now - lastTap < 350) {
            e.preventDefault();
            startY = e.touches[0].clientY;
            startZoom = map.getView().getZoom();
            isHoldZoom = true;
            holdTimeout = setTimeout(function() {
              mapDiv.addEventListener('touchmove', moveHandler, { passive: false });
            }, 100);
          } else {
            lastTap = now;
            isHoldZoom = false;
            if (holdTimeout) clearTimeout(holdTimeout);
          }
        });
        mapDiv.addEventListener('touchend', function(e) {
          if (isHoldZoom) {
            isHoldZoom = false;
            mapDiv.removeEventListener('touchmove', moveHandler, { passive: false });
          }
          if (holdTimeout) clearTimeout(holdTimeout);
        });
        function moveHandler(e) {
          if (!isHoldZoom || e.touches.length !== 1) return;
          e.preventDefault();
          var dy = e.touches[0].clientY - startY;
          var newZoom = startZoom - dy / 80;
          var view = map.getView();
          newZoom = Math.max(view.getMinZoom(), Math.min(view.getMaxZoom(), newZoom));
          view.setZoom(newZoom);
        }
      })();
    }

    function updateDateUI() {
      let isDisney = showingDisney;
      let label = isDisney
        ? (disneyDates.find(e => e.code === disneyServer) || {}).label
        : (esriDates.find(e => e.code === esriServer) || {}).label;

      dateBtn.style.display = 'inline-flex';
      datePopup.style.display = 'none';
      quickSwitchBtn.style.display = (lastTwoDates[1]) ? 'flex' : 'none';
      currentDateDisplay.textContent = label || '';
      currentDateDisplay.style.display = 'block';
    }

    // About modal logic (no close button)
    const logo = document.getElementById('logo');
    const disclaimerModal = document.getElementById('disclaimer-modal');
    const viewportMeta = document.getElementById('viewport-meta');
    if (logo && disclaimerModal) {
      logo.style.cursor = 'pointer';
      logo.onclick = function() {
        disclaimerModal.classList.add('active');
        if (viewportMeta) {
          viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover');
        }
      };
      disclaimerModal.onclick = function(e) {
        if (e.target === disclaimerModal) {
          disclaimerModal.classList.remove('active');
          if (viewportMeta) {
            viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=yes, viewport-fit=cover');
          }
        }
      };
    }
  </script>
</body>
</html>
