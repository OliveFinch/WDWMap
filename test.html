<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WDW Magic Explorer</title>
  <meta id="viewport-meta" name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#23287b">
  <meta property="og:title" content="WDW Magic Explorer">
  <meta property="og:description" content="Explore historical Disney World maps with custom overlays.">
  <meta property="og:image" content="icon-512.png">
  <meta property="og:type" content="website">
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior: none; overflow: hidden; font-family: Arial, Helvetica, sans-serif;}
    #map { width: 100vw; height: 100vh; touch-action: none; -webkit-user-select: none; user-select: none; }
    button, .ol-control-inner, #date-btn-inner, #left-date-btn-inner, #quick-switch-btn, #roads-btn, #findme-btn, #compare-btn, #highlight-btn { touch-action: manipulation;}
    .control-row { position: absolute; top: 8px; right: 8px; display: flex; flex-direction: column; align-items: flex-end; z-index: 1100; gap: 8px; }
    .left-control-col { position: absolute; top: 8px; left: 8px; display: flex; flex-direction: column; align-items: flex-start; z-index: 1100; gap: 8px; }
    .btn-wrap { position: relative; }
    .ol-control.custom-btn { position: static; padding: 0; border: none; background: none; box-shadow: none; outline: none; margin: 0; }
    .ol-control-inner, #quick-switch-btn { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(255,255,255,0.85); border: 1.5px solid #ccc; border-radius: 8px; font-size: 15px; color: #222; cursor: pointer; transition: background 0.2s, border 0.2s; user-select: none; padding: 0; font-family: Arial, Helvetica, sans-serif; }
    .ol-control-inner img, #quick-switch-btn img { width: 24px; height: 24px; display: block; pointer-events: none; user-select: none; }
    .ol-control-inner:active, .ol-control-inner:focus, .ol-control-inner:hover, #quick-switch-btn:active, #quick-switch-btn:focus, #quick-switch-btn:hover { background: #f8f8f8; border-color: #999;}
    #logo { position: absolute; left: 16px; bottom: 16px; z-index: 1200; pointer-events: auto; opacity: 0.93; cursor: pointer;}
    #logo img { display: block; width: 200px; height: 36px; max-width: 98vw;}
    #findme-message { display: none; position: absolute; top: 16px; left: 50%; transform: translateX(-50%); z-index: 2000; background: rgba(255,255,255,0.92); color: #d62525; font-size: 17px; font-family: Arial, Helvetica, sans-serif; font-weight: bold; text-align: center; opacity: 0; padding: 7px 20px; border-radius: 16px; box-shadow: 0 2px 8px #0001; transition: opacity 0.4s; pointer-events: none;}
    #date-btn, #left-date-btn, #compare-btn, #highlight-btn { padding: 0; border: none; background: none; outline: none; font-family: Arial, Helvetica, sans-serif; cursor: pointer;}
    #date-btn-inner, #left-date-btn-inner { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(255,255,255,0.85); border: 1.5px solid #ccc; border-radius: 8px; font-size: 15px; color: #222; cursor: pointer; font-family: Arial, Helvetica, sans-serif;}
    #date-btn-inner:active, #date-btn-inner:focus, #left-date-btn-inner:active, #left-date-btn-inner:focus { background: #f8f8f8; border-color: #999;}
    #date-btn-inner img, #left-date-btn-inner img { width: 22px; height: 22px;}
    #date-popup, #left-date-popup { display: none; opacity: 0; position: absolute; min-width: 180px; max-height: 70vh; overflow-y: auto; background: rgba(255,255,255,0.96); border: 1.5px solid #ccc; border-radius: 8px; box-shadow: 0 3px 15px #0002; z-index: 1400; font-family: Arial, Helvetica, sans-serif;}
    #date-popup { right: 0; top: 48px; }
    #left-date-popup { left: 0; top: 48px; }
    .date-popup-item { display: block; width: 100%; border: none; background: none; font-size: 15px; text-align: left; padding: 9px 16px; cursor: pointer; font-family: Arial, Helvetica, sans-serif;}
    .date-popup-item.selected { background: #f2f5fa; color: #3761c4; font-weight: bold;}
    .date-popup-item:active, .date-popup-item:hover { background: #f8f8f8;}
    #current-date-display { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1500; background: none; color: #fff; font-size: 22px; font-family: Arial, Helvetica, sans-serif; font-weight: bold; text-shadow: 0 3px 16px #222, 0 1px 0 #222; pointer-events: none; opacity: 0.97; padding: 0 22px; white-space: nowrap;}
    #quick-switch-btn { position: absolute; bottom: calc(18px + env(safe-area-inset-bottom, 0)); right: 16px; z-index: 1300; display: none; width: 40px; height: 40px; border-radius: 8px; background: rgba(255,255,255,0.90); border: 1.5px solid #ccc; box-shadow: 0 3px 15px #0002; justify-content: center; align-items: center; color: #23287b; padding: 0; cursor: pointer;}
    #quick-switch-btn:active, #quick-switch-btn:focus, #quick-switch-btn:hover { background: #f8f8f8; border-color: #999;}
    #quick-switch-btn img { width: 24px; height: 24px;}
    #roads-btn { position: absolute; right: 8px; top: 56px; z-index: 1000; }
    #findme-btn { position: absolute; right: 8px; top: 104px; z-index: 1000; }

    /* Swipe UI (Compare mode) */
    #swipe-thumb {
      position: absolute; top: 0; bottom: 0;
      width: 5px; background: #e24141cc;
      z-index: 1300; cursor: ew-resize;
      border-radius: 3px; box-shadow: 0 2px 12px #3336;
      pointer-events: auto; display: none;
    }
    #swipe-handle {
      position: absolute; width: 34px; height: 34px;
      background: #fff; border: 4px solid #e24141cc; border-radius: 50%;
      box-shadow: 0 2px 12px #2225; z-index: 1400; cursor: grab; touch-action: none;
      display: none; transition: background 0.1s, border 0.1s;
    }
    #swipe-handle:active { background: #ffeaea; border-color: #e24141; }

    /* About modal */
    #disclaimer-modal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.45); align-items: center; justify-content: center; transition: opacity 0.2s;}
    #disclaimer-modal.active { display: flex;}
    #disclaimer-content { background: #fff; border-radius: 14px; padding: 24px 20px 14px 20px; box-shadow: 0 6px 32px #0003; max-width: 96vw; width: 350px; font-size: 15px; color: #222; text-align: left; position: relative;}
    #disclaimer-content h3 { margin-top: 0; margin-bottom: 14px; font-size: 18px; color: #2a3487;}
    #coffee-link { display: inline-block; margin-top: 8px; margin-bottom: 14px; color: #0070ba; font-weight: bold; text-decoration: none; border: 1.5px solid #0070ba; border-radius: 7px; padding: 6px 15px; background: #f7fbff; transition: background 0.2s, border 0.2s;}
    #coffee-link:hover { background: #eaf6ff; border-color: #005fa3;}

    @media (max-width: 600px) {
      .control-row { right: 8px; top: 8px; gap: 6px; }
      .left-control-col { left: 8px; top: 8px; gap: 6px; }
      .ol-control-inner, #date-btn-inner, #left-date-btn-inner, #quick-switch-btn { width: 32px; height: 32px; border-radius: 6px; font-size: 13px; }
      .ol-control-inner img, #date-btn-inner img, #left-date-btn-inner img, #quick-switch-btn img { width: 18px; height: 18px; }
      #logo { left: 50%; transform: translateX(-50%); bottom: 8px;}
      #logo img { width: 180px !important; height: 32px !important; }
      #current-date-display { font-size: 16px; padding: 0 10px; top: 10px; }
      #quick-switch-btn { bottom: calc(8px + env(safe-area-inset-bottom, 0)); right: 8px; }
      #date-popup, #left-date-popup { min-width: 140px; max-height: 50vh; top: 40px; }
      #swipe-handle { width: 40px; height: 40px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- RIGHT controls (Disney/Sat, Date, Compare/Highlight, popup) -->
  <div class="control-row">
    <div class="btn-wrap">
      <button id="date-btn" type="button">
        <span id="date-btn-inner" class="ol-control-inner">
          <img src="icons/calendar.svg" alt="Date Selector (Right)">
        </span>
      </button>
      <div id="date-popup"></div>
    </div>

    <button id="toggle-btn" class="ol-control custom-btn">
      <span class="ol-control-inner" id="toggle-icon">
        <img src="icons/satellite.svg" alt="Satellite">
      </span>
    </button>

    <!-- Compare: only visible in Disney Map mode -->
    <button id="compare-btn" class="ol-control custom-btn" style="display:none;">
      <span class="ol-control-inner" id="compare-icon">
        <img src="icons/compare.svg" alt="Compare">
      </span>
    </button>

    <!-- Highlight: only visible while compare mode is active -->
    <button id="highlight-btn" class="ol-control custom-btn" style="display:none;">
      <span class="ol-control-inner" id="highlight-icon">
        <img src="icons/highlight.svg" alt="Highlight">
      </span>
    </button>
  </div>

  <!-- LEFT controls (left-side calendar for Compare mode) -->
  <div class="left-control-col" id="left-controls" style="display:none;">
    <div class="btn-wrap">
      <button id="left-date-btn" type="button">
        <span id="left-date-btn-inner" class="ol-control-inner">
          <img src="icons/calendar.svg" alt="Date Selector (Left)">
        </span>
      </button>
      <div id="left-date-popup"></div>
    </div>
  </div>

  <!-- Roads/Find me (unchanged positions) -->
  <button id="roads-btn" class="ol-control custom-btn">
    <span class="ol-control-inner" id="roads-icon">
      <img src="icons/roads.svg" alt="Roads">
    </span>
  </button>
  <button id="findme-btn" class="ol-control custom-btn">
    <span class="ol-control-inner" id="findme-icon">
      <img src="icons/locateme.svg" alt="Locate Me">
    </span>
  </button>

  <div id="findme-message"></div>

  <!-- Quick switch -->
  <button id="quick-switch-btn" title="Quick Switch Dates" class="ol-control-inner">
    <img src="icons/switch.svg" alt="Switch">
  </button>

  <!-- Branding + date display -->
  <div id="logo"><img src="logo.svg" alt="WDW Magic Explorer Logo"></div>
  <div id="current-date-display"></div>

  <!-- About Modal -->
  <div id="disclaimer-modal">
    <div id="disclaimer-content">
      <h3>About</h3>
      <p>
        <strong>WDW Magic Explorer</strong> is a fan-made tool for viewing and comparing historical and current map imagery for Walt Disney World in Florida.<br>
        Easily switch between official Disney park maps from different years, ESRI Wayback satellite overlays. Features include date switching, user location, and fast map view switching for exploration and research.<br><br>
        Made for Disney fans and anyone curious about how the parks have changed over time.
      </p>
      <a id="coffee-link" href="https://paypal.me/AshJB" target="_blank">☕ Buy me a Coffee</a>
      <p>
        Created by Ashley Burton.<br><br>
        <strong>Legal & Notices</strong><br>
        This is an independent, non-commercial project and is not affiliated with, endorsed by, or connected to The Walt Disney Company.<br>
        All map imagery &copy; Disney or their respective owners.<br><br>
        ESRI World Imagery &copy; Esri and its data providers. Imagery may be copyright of other providers as indicated within the map data.
      </p>
    </div>
  </div>

  <!-- Swipe UI (Compare mode) -->
  <div id="swipe-thumb"></div>
  <div id="swipe-handle" title="Drag to compare"></div>

  <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
  <script>
    // ---------- helpers for DeltaE highlight ----------
    function rgb2lab(r, g, b) {
      r /= 255; g /= 255; b /= 255;
      r = r > 0.04045 ? Math.pow((r + 0.055)/1.055, 2.4) : r/12.92;
      g = g > 0.04045 ? Math.pow((g + 0.055)/1.055, 2.4) : g/12.92;
      b = b > 0.04045 ? Math.pow((b + 0.055)/1.055, 2.4) : b/12.92;
      let x = r*0.4124 + g*0.3576 + b*0.1805;
      let y = r*0.2126 + g*0.7152 + b*0.0722;
      let z = r*0.0193 + g*0.1192 + b*0.9505;
      [x, y, z] = [x/0.95047, y/1.00000, z/1.08883];
      x = x > 0.008856 ? Math.pow(x,1/3) : (7.787*x) + 16/116;
      y = y > 0.008856 ? Math.pow(y,1/3) : (7.787*y) + 16/116;
      z = z > 0.008856 ? Math.pow(z,1/3) : (7.787*z) + 16/116;
      return [ (116*y)-16, 500*(x-y), 200*(y-z) ];
    }
    function deltaE(labA, labB) {
      const dL = labA[0] - labB[0];
      const da = labA[1] - labB[1];
      const db = labA[2] - labB[2];
      return Math.sqrt(dL*dL + da*da + db*db);
    }

    // ---------- app state ----------
    let serverOptions = [];
    let disneyServer = null;            // "right" date (primary)
    let leftDisneyServer = null;        // "left" date (compare)
    let lastTwoDates = [null, null];

    let dateBtn, datePopup, leftDateBtn, leftDatePopup, currentDateDisplay, quickSwitchBtn;
    let disneyLayer, esriLayer, roadsLayer, map;
    let showingDisney = true;
    let roadsOn = false;

    // Compare/Highlight state + layers
    let compareMode = false;
    let highlightOn = false;
    let leftLayer = null, rightLayer = null, highlightLayer = null;
    let swipeRatio = 0.5;

    // swipe UI handles
    const swipeThumb = document.getElementById('swipe-thumb');
    const swipeHandle = document.getElementById('swipe-handle');

    const disneyWorldExtent = ol.proj.transformExtent(
      [-81.9200, 28.1772, -81.2244, 28.6390], 'EPSG:4326', 'EPSG:3857'
    );

    fetch('servers2.json')
      .then(r => r.json())
      .then(json => {
        serverOptions = json;
        disneyServer = serverOptions[serverOptions.length - 1].code;
        // Default left side to previous date if available
        leftDisneyServer = serverOptions[serverOptions.length - 2]
          ? serverOptions[serverOptions.length - 2].code
          : serverOptions[0].code;

        initMap();
        setupUI();
        updateDateUI();
      })
      .catch(err => alert('Failed to load servers2.json: ' + err));

    // ---------- data access ----------
    function findRec(code){ return serverOptions.find(opt => opt.code === code); }
    function getLabelForCode(code) { const rec = findRec(code); return rec ? rec.label : ''; }
    function getEsriLabelForCode(code) { const rec = findRec(code); return rec && rec.esri_label ? rec.esri_label : ''; }
    function getEsriIdForCode(code) { const rec = findRec(code); return rec && rec.esri_id ? rec.esri_id : ''; }

    // ---------- base layers ----------
    function makeDisneyLayer(server) {
      return new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: `https://cdn6.parksmedia.wdprapps.disney.com/media/maps/prod/${server}/{z}/{x}/{y}.jpg`,
          minZoom: 0, maxZoom: 20,
          crossOrigin: 'anonymous'
        }),
        visible: true
      });
    }
    function makeEsriLayer(esri_id) {
      if (!esri_id) return null;
      let lyr = new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: `https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/WMTS/1.0.0/default028mm/MapServer/tile/${esri_id}/{z}/{y}/{x}`,
          minZoom: 0, maxZoom: 20
        }),
        visible: false
      });
      lyr.set('esri_id', esri_id);
      return lyr;
    }
    function makeRoadsLayer() {
      return new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: 'https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}',
          minZoom: 0, maxZoom: 20
        }),
        visible: false, opacity: 0.85
      });
    }

    // ---------- compare layers ----------
    function makeLayer(code) { // disney map tile source with gentle stagger
      return new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: `https://cdn6.parksmedia.wdprapps.disney.com/media/maps/prod/${code}/{z}/{x}/{y}.jpg`,
          maxZoom: 20,
          crossOrigin: 'anonymous',
          tileLoadFunction: (imageTile, src) => {
            setTimeout(() => { imageTile.getImage().src = src; }, 60 + Math.random() * 180);
          }
        })
      });
    }
    function makeHighlightLayer(baseCode, compareCode) {
      const baseTpl = `https://cdn6.parksmedia.wdprapps.disney.com/media/maps/prod/${baseCode}/{z}/{x}/{y}.jpg`;
      const cmpTpl  = `https://cdn6.parksmedia.wdprapps.disney.com/media/maps/prod/${compareCode}/{z}/{x}/{y}.jpg`;
      return new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: baseTpl,
          maxZoom: 20,
          crossOrigin: 'anonymous',
          tileLoadFunction: function(tile, src) {
            const zxy = tile.tileCoord;
            const compareUrl = cmpTpl.replace('{z}', zxy[0]).replace('{x}', zxy[1]).replace('{y}', zxy[2]);
            const baseImg = new Image(); baseImg.crossOrigin = 'anonymous';
            baseImg.onload = function() {
              const cmpImg = new Image(); cmpImg.crossOrigin = 'anonymous';
              cmpImg.onload = function() {
                const w = baseImg.width || cmpImg.width || 256;
                const h = baseImg.height || cmpImg.height || 256;
                const can = document.createElement('canvas'); can.width = w; can.height = h;
                const ctx = can.getContext('2d');

                const c1 = document.createElement('canvas'); c1.width = w; c1.height = h;
                const g1 = c1.getContext('2d'); g1.drawImage(baseImg, 0, 0, w, h);
                const d1 = g1.getImageData(0, 0, w, h);

                const c2 = document.createElement('canvas'); c2.width = w; c2.height = h;
                const g2 = c2.getContext('2d'); g2.drawImage(cmpImg, 0, 0, w, h);
                const d2 = g2.getImageData(0, 0, w, h);

                const out = ctx.createImageData(w, h);
                const threshold = 20; // tuned; can expose later if you want
                for (let i = 0; i < d1.data.length; i += 4) {
                  const lab1 = rgb2lab(d1.data[i], d1.data[i+1], d1.data[i+2]);
                  const lab2 = rgb2lab(d2.data[i], d2.data[i+1], d2.data[i+2]);
                  if (deltaE(lab1, lab2) > threshold) {
                    out.data[i]=255; out.data[i+1]=0; out.data[i+2]=0; out.data[i+3]=200;
                  } else {
                    const gray = 0.3*d1.data[i] + 0.59*d1.data[i+1] + 0.11*d1.data[i+2];
                    out.data[i]=out.data[i+1]=out.data[i+2]=gray; out.data[i+3]=d1.data[i+3];
                  }
                }
                ctx.putImageData(out, 0, 0);
                tile.getImage().src = can.toDataURL();
              };
              cmpImg.onerror = () => { tile.getImage().src = src; };
              cmpImg.src = compareUrl;
            };
            baseImg.onerror = () => {
              const blank = document.createElement('canvas'); blank.width = blank.height = 256;
              tile.getImage().src = blank.toDataURL();
            };
            baseImg.src = src;
          }
        })
      });
    }

    // ---------- roads topmost ----------
    function setRoadsLayerState() {
      if (!roadsLayer) return;
      roadsLayer.setVisible(roadsOn);
      const layers = map.getLayers();
      // ensure roads on top
      if (layers.getArray()[layers.getLength()-1] !== roadsLayer) {
        map.removeLayer(roadsLayer);
        map.addLayer(roadsLayer);
      }
    }
    function onBaseLayerChange() { setRoadsLayerState(); }

    // ---------- map init ----------
    function initMap() {
      disneyLayer = makeDisneyLayer(disneyServer);
      esriLayer = makeEsriLayer(getEsriIdForCode(disneyServer));
      roadsLayer = makeRoadsLayer();

      disneyLayer.getSource().set('extent', disneyWorldExtent);
      if (esriLayer) esriLayer.getSource().set('extent', disneyWorldExtent);
      roadsLayer.getSource().set('extent', disneyWorldExtent);

      map = new ol.Map({
        target: 'map',
        layers: [disneyLayer, esriLayer, roadsLayer],
        view: new ol.View({
          center: ol.proj.fromLonLat([-81.5494, 28.3747]),
          zoom: 16, minZoom: 0, maxZoom: 20,
          extent: disneyWorldExtent
        })
      });
    }

    // ---------- UI setup ----------
    function setupUI() {
      dateBtn = document.getElementById('date-btn');
      datePopup = document.getElementById('date-popup');
      leftDateBtn = document.getElementById('left-date-btn');
      leftDatePopup = document.getElementById('left-date-popup');
      currentDateDisplay = document.getElementById('current-date-display');
      quickSwitchBtn = document.getElementById('quick-switch-btn');

      lastTwoDates = [disneyServer, null];

      // populate popup helpers
      function fillDatePopup(container, selectedCode, onPick, labelMapper) {
        container.innerHTML = '';
        serverOptions.slice().reverse().forEach(opt => {
          const btn = document.createElement('button');
          const label = labelMapper ? labelMapper(opt) : opt.label;
          btn.className = 'date-popup-item' + (opt.code === selectedCode ? ' selected' : '');
          btn.textContent = label;
          btn.onclick = () => { onPick(opt.code); hidePopup(container); };
          container.appendChild(btn);
        });
      }
      function showPopup(container, anchorBtn, selectedCode, onPick, labelMapper) {
        fillDatePopup(container, selectedCode, onPick, labelMapper);
        container.style.display = 'block';
        setTimeout(() => container.style.opacity = '1', 10);
        const hide = (e) => { if (!container.contains(e.target) && !anchorBtn.contains(e.target)) hidePopup(container); };
        setTimeout(() => {
          document.addEventListener('mousedown', hide, { once: true });
          document.addEventListener('touchstart', hide, { once: true });
        }, 0);
      }
      function hidePopup(container) {
        container.style.opacity = '0';
        setTimeout(() => container.style.display = 'none', 180);
      }

      // right-side date button (controls disneyServer OR the "right" date in compare)
      dateBtn.onclick = function() {
        const labelMapper = (opt) => showingDisney ? opt.label : (opt.esri_label || opt.label);
        const selected = compareMode ? disneyServer : disneyServer;
        showPopup(datePopup, dateBtn, selected, (code) => setRightDate(code), labelMapper);
      };

      // left-side date button (only visible in compare mode)
      leftDateBtn.onclick = function() {
        showPopup(leftDatePopup, leftDateBtn, leftDisneyServer, (code) => setLeftDate(code));
      };

      // Toggle Disney/Satellite
      document.getElementById('toggle-btn').onclick = function() {
        if (compareMode) { // leaving compare if switching base type
          exitCompareMode();
        }
        showingDisney = !showingDisney;
        disneyLayer.setVisible(showingDisney);
        if (!esriLayer || esriLayer.get('esri_id') !== getEsriIdForCode(disneyServer)) {
          if (esriLayer) map.removeLayer(esriLayer);
          esriLayer = makeEsriLayer(getEsriIdForCode(disneyServer));
          if (esriLayer) {
            esriLayer.getSource().set('extent', disneyWorldExtent);
            map.getLayers().setAt(1, esriLayer);
          }
        }
        if (esriLayer) esriLayer.setVisible(!showingDisney);
        onBaseLayerChange();
        updateDateUI();
        document.getElementById('toggle-icon').querySelector('img').src =
          showingDisney ? 'icons/satellite.svg' : 'icons/mouse.svg';
        document.getElementById('toggle-icon').querySelector('img').alt =
          showingDisney ? 'Satellite' : 'Disney Map';
      };

      // Compare button (visible only in Disney Map mode)
      document.getElementById('compare-btn').onclick = function() {
        if (!compareMode) enterCompareMode();
        else exitCompareMode();
      };

      // Highlight button (toggles highlight within compare)
      document.getElementById('highlight-btn').onclick = function() {
        if (!compareMode) return;
        highlightOn = !highlightOn;
        if (highlightOn) launchHighlightMode();
        else launchSwipeMode();
        updateDateUI();
      };

      // Quick switch between last two dates (applies to current side when not in compare; to right side in compare)
      quickSwitchBtn.onclick = function() {
        if (!lastTwoDates[1]) return;
        setRightDate(lastTwoDates[1]);
      };

      // roads toggle
      document.getElementById('roads-btn').onclick = function() {
        roadsOn = !roadsOn;
        document.getElementById('roads-icon').querySelector('img').src =
          roadsOn ? 'icons/no_roads.svg' : 'icons/roads.svg';
        document.getElementById('roads-icon').querySelector('img').alt =
          roadsOn ? 'No Roads' : 'Roads';
        setRoadsLayerState();
      };

      // FIND ME
      const findmeBtn = document.getElementById('findme-btn');
      const findmeMessage = document.getElementById('findme-message');
      let userLocationLayer = null;
      findmeBtn.onclick = function() {
        if (!navigator.geolocation) { showFindMeMessage('Geolocation not supported'); return; }
        navigator.geolocation.getCurrentPosition(function(pos) {
          const coords = [pos.coords.longitude, pos.coords.latitude];
          const projected = ol.proj.fromLonLat(coords);
          const within = ol.extent.containsCoordinate(disneyWorldExtent, projected);
          if (!within) { showFindMeMessage('Outside of WDW'); removeUserLocation(); return; }
          removeUserLocation();
          userLocationLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
              features: [new ol.Feature({geometry: new ol.geom.Point(projected)})]
            }),
            style: new ol.style.Style({
              image: new ol.style.Circle({
                radius: 10, fill: new ol.style.Fill({color: 'rgba(0,116,217,0.35)'}),
                stroke: new ol.style.Stroke({color: '#0074d9', width: 3})
              })
            }),
            zIndex: 99
          });
          map.addLayer(userLocationLayer);
          map.getView().animate({center: projected, zoom: 17, duration: 800});
        }, function() { showFindMeMessage('Unable to get location'); }, { enableHighAccuracy: true });
      };
      function showFindMeMessage(msg) {
        findmeMessage.textContent = msg;
        findmeMessage.style.display = 'block';
        setTimeout(() => { findmeMessage.style.opacity = '1'; }, 10);
        setTimeout(() => {
          findmeMessage.style.opacity = '0';
          setTimeout(() => { findmeMessage.style.display = 'none'; }, 400);
        }, 2200);
      }
      function removeUserLocation() {
        if (userLocationLayer) { map.removeLayer(userLocationLayer); userLocationLayer = null; }
      }

      // Double-tap & hold zoom
      (function() {
        let lastTap = 0, isHoldZoom = false, startY = 0, startZoom = 0;
        const mapDiv = document.getElementById('map'); let holdTimeout = null;
        function moveHandler(e) {
          if (!isHoldZoom || e.touches.length !== 1) return;
          e.preventDefault();
          const dy = e.touches[0].clientY - startY;
          const newZoom = Math.max(map.getView().getMinZoom(), Math.min(map.getView().getMaxZoom(), startZoom - dy / 80));
          map.getView().setZoom(newZoom);
        }
        mapDiv.addEventListener('touchstart', function(e) {
          if (e.touches.length !== 1) return;
          const now = Date.now();
          if (now - lastTap < 350) {
            e.preventDefault();
            startY = e.touches[0].clientY;
            startZoom = map.getView().getZoom();
            isHoldZoom = true;
            holdTimeout = setTimeout(() => { mapDiv.addEventListener('touchmove', moveHandler, { passive: false }); }, 100);
          } else {
            lastTap = now; isHoldZoom = false; if (holdTimeout) clearTimeout(holdTimeout);
          }
        });
        mapDiv.addEventListener('touchend', function() {
          if (isHoldZoom) { isHoldZoom = false; mapDiv.removeEventListener('touchmove', moveHandler, { passive: false }); }
          if (holdTimeout) clearTimeout(holdTimeout);
        });
      })();
    }

    // ---------- date handlers ----------
    function setRightDate(newCode) {
      if (disneyServer === newCode) return;
      if (lastTwoDates[0] !== newCode) lastTwoDates = [newCode, lastTwoDates[0]];
      disneyServer = newCode;

      if (!compareMode) {
        if (showingDisney) {
          const vis = disneyLayer.getVisible();
          map.removeLayer(disneyLayer);
          disneyLayer = makeDisneyLayer(newCode);
          disneyLayer.setVisible(vis);
          disneyLayer.getSource().set('extent', disneyWorldExtent);
          map.getLayers().setAt(0, disneyLayer);
        } else {
          const esri_id = getEsriIdForCode(newCode);
          const vis = esriLayer && esriLayer.getVisible();
          if (!esriLayer || esriLayer.get('esri_id') !== esri_id) {
            if (esriLayer) map.removeLayer(esriLayer);
            esriLayer = makeEsriLayer(esri_id);
            if (esriLayer) {
              esriLayer.set('esri_id', esri_id);
              esriLayer.getSource().set('extent', disneyWorldExtent);
              map.getLayers().setAt(1, esriLayer);
            }
          }
          if (esriLayer) esriLayer.setVisible(vis);
        }
      } else {
        // compare mode updates the "right" side
        if (highlightOn) launchHighlightMode(); else launchSwipeMode();
      }
      onBaseLayerChange();
      updateDateUI();
    }
    function setLeftDate(newCode) {
      if (leftDisneyServer === newCode) return;
      leftDisneyServer = newCode;
      if (compareMode) { if (highlightOn) launchHighlightMode(); else launchSwipeMode(); }
      updateDateUI();
    }

    // ---------- UI updates ----------
    function updateDateUI() {
      const compareBtn = document.getElementById('compare-btn');
      const highlightBtn = document.getElementById('highlight-btn');
      const leftControls = document.getElementById('left-controls');

      // visibility rules
      compareBtn.style.display = showingDisney ? 'inline-flex' : 'none';
      leftControls.style.display = compareMode ? 'flex' : 'none';
      highlightBtn.style.display = compareMode ? 'inline-flex' : 'none';

      // date display
      if (!compareMode) {
        const text = showingDisney
          ? getLabelForCode(disneyServer)
          : (getEsriLabelForCode(disneyServer) || (getLabelForCode(disneyServer) + ' (Satellite)'));
        currentDateDisplay.textContent = text;
      } else {
        currentDateDisplay.textContent = `${getLabelForCode(leftDisneyServer)}  |  ${getLabelForCode(disneyServer)}`;
      }
      currentDateDisplay.style.display = 'block';

      // quick switch visible if we have history (applies to right date)
      quickSwitchBtn.style.display = (lastTwoDates[1]) ? 'flex' : 'none';

      // highlight icon state (optional: could swap icon to indicate active)
      document.getElementById('highlight-icon').style.opacity = highlightOn ? '1' : '0.85';
    }

    // ---------- Compare mode lifecycle ----------
    function enterCompareMode() {
      if (!showingDisney) return; // safety: only in Disney mode
      compareMode = true; highlightOn = false;
      launchSwipeMode();
      updateDateUI();
    }
    function exitCompareMode() {
      compareMode = false; highlightOn = false; swipeRatio = 0.5;

      // remove compare layers
      if (leftLayer) { map.removeLayer(leftLayer); leftLayer = null; }
      if (rightLayer) { map.removeLayer(rightLayer); rightLayer = null; }
      if (highlightLayer) { map.removeLayer(highlightLayer); highlightLayer = null; }

      // restore single-base layers
      disneyLayer.setVisible(showingDisney);
      if (esriLayer) esriLayer.setVisible(!showingDisney);

      // hide swipe UI
      swipeThumb.style.display = 'none';
      swipeHandle.style.display = 'none';

      onBaseLayerChange();
      updateDateUI();
    }

    // ---------- Compare: Swipe or Highlight ----------
    function launchSwipeMode() {
      highlightOn = false;

      // clear previous compare layers
      if (leftLayer) { map.removeLayer(leftLayer); leftLayer = null; }
      if (rightLayer) { map.removeLayer(rightLayer); rightLayer = null; }
      if (highlightLayer) { map.removeLayer(highlightLayer); highlightLayer = null; }

      // hide single base layers
      disneyLayer.setVisible(false);
      if (esriLayer) esriLayer.setVisible(false);

      // add left + right
      leftLayer = makeLayer(leftDisneyServer);   map.addLayer(leftLayer);
      rightLayer = makeLayer(disneyServer);      map.addLayer(rightLayer);

      // clip right side by swipe
      rightLayer.on('prerender', function(evt) {
        const ctx = evt.context;
        const w = ctx.canvas.width, h = ctx.canvas.height;
        const x = Math.round(w * swipeRatio);
        ctx.save(); ctx.beginPath(); ctx.rect(x, 0, w - x, h); ctx.clip();
      });
      rightLayer.on('postrender', function(evt) { evt.context.restore(); });

      // show swipe UI
      swipeThumb.style.display = 'block';
      swipeHandle.style.display = 'block';
      updateSwipeUI();

      setRoadsLayerState();
    }

    function launchHighlightMode() {
      // clear others
      if (leftLayer) { map.removeLayer(leftLayer); leftLayer = null; }
      if (rightLayer) { map.removeLayer(rightLayer); rightLayer = null; }
      if (highlightLayer) { map.removeLayer(highlightLayer); highlightLayer = null; }

      // hide single base layers
      disneyLayer.setVisible(false);
      if (esriLayer) esriLayer.setVisible(false);

      // build highlight on top
      highlightLayer = makeHighlightLayer(leftDisneyServer, disneyServer);
      map.addLayer(highlightLayer);

      // hide swipe UI
      swipeThumb.style.display = 'none';
      swipeHandle.style.display = 'none';

      setRoadsLayerState();
    }

    // ---------- swipe drag logic ----------
    function updateSwipeUI() {
      const mapDiv = map.getTargetElement();
      const w = mapDiv.clientWidth, h = mapDiv.clientHeight;
      const x = Math.round(w * swipeRatio);

      swipeThumb.style.left = (x - (swipeThumb.offsetWidth / 2)) + 'px';
      swipeThumb.style.top = '0px';
      swipeThumb.style.height = h + 'px';

      let handlePos = (window.innerWidth <= 600) ? 0.75 : 0.90;
      swipeHandle.style.left = (x - (swipeHandle.offsetWidth / 2) + (swipeThumb.offsetWidth / 2) - 2) + 'px';
      swipeHandle.style.top = (Math.round(h * handlePos) - (swipeHandle.offsetHeight / 2)) + 'px';
      map.render();
    }
    function startSwipeDrag(e) {
      e.preventDefault(); document.body.style.userSelect = 'none';
      function move(ev) {
        const clientX = ev.touches ? ev.touches[0].clientX : ev.clientX;
        const rect = map.getTargetElement().getBoundingClientRect();
        swipeRatio = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
        updateSwipeUI();
      }
      function stop() {
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', stop);
        document.removeEventListener('touchmove', move);
        document.removeEventListener('touchend', stop);
        document.body.style.userSelect = '';
      }
      document.addEventListener('mousemove', move);
      document.addEventListener('mouseup', stop);
      document.addEventListener('touchmove', move, { passive: false });
      document.addEventListener('touchend', stop);
    }
    swipeThumb.addEventListener('mousedown', startSwipeDrag);
    swipeThumb.addEventListener('touchstart', startSwipeDrag, { passive: false });
    swipeHandle.addEventListener('mousedown', startSwipeDrag);
    swipeHandle.addEventListener('touchstart', startSwipeDrag, { passive: false });
    window.addEventListener('resize', () => setTimeout(updateSwipeUI, 30));
    window.addEventListener('load', () => setTimeout(updateSwipeUI, 40));

    // ---------- UI text & modal ----------
    // (same as your original)
    const logo = document.getElementById('logo');
    const disclaimerModal = document.getElementById('disclaimer-modal');
    const viewportMeta = document.getElementById('viewport-meta');
    if (logo && disclaimerModal) {
      logo.style.cursor = 'pointer';
      logo.onclick = function() {
        disclaimerModal.classList.add('active');
        if (viewportMeta) {
          viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover');
        }
      };
      disclaimerModal.onclick = function(e) {
        if (e.target === disclaimerModal) {
          disclaimerModal.classList.remove('active');
          if (viewportMeta) {
            viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=yes, viewport-fit=cover');
          }
        }
      };
    }
  </script>
</body>
</html>
