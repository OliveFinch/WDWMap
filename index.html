<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WDW Magic Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, viewport-fit=cover">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overscroll-behavior: none;
      overflow: hidden;
      font-family: Arial, Helvetica, sans-serif;
    }
    #map {
      width: 100vw;
      height: 100vh;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    .control-row {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      flex-direction: row;
      align-items: center;
      z-index: 1100;
    }
    .ol-control.custom-btn {
      position: static;
      padding: 0;
      border: none;
      background: none;
      box-shadow: none;
      outline: none;
      margin-bottom: 0;
    }
    #toggle-btn { margin: 0; }
    #roads-btn {
      position: absolute;
      right: 8px;
      top: 56px;
      z-index: 1000;
    }
    #findme-btn {
      position: absolute;
      right: 8px;
      top: 104px;
      z-index: 1000;
    }
    .ol-control-inner,
    #quick-switch-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.85);
      border: 1.5px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      color: #222;
      cursor: pointer;
      transition: background 0.2s, border 0.2s;
      user-select: none;
      padding: 0;
      font-family: Arial, Helvetica, sans-serif;
    }
    .ol-control-inner img,
    #quick-switch-btn img {
      width: 24px;
      height: 24px;
      display: block;
      pointer-events: none;
      user-select: none;
    }
    .ol-control-inner:active,
    .ol-control-inner:focus,
    .ol-control-inner:hover,
    #quick-switch-btn:active,
    #quick-switch-btn:focus,
    #quick-switch-btn:hover {
      background: #f8f8f8;
      border-color: #999;
    }
    .ol-rotate {
      top: 80px !important;
      left: 8px !important;
      right: auto !important;
    }
    #logo {
      position: absolute;
      left: 16px;
      bottom: 16px;
      z-index: 1200;
      pointer-events: none;
      opacity: 0.93;
    }
    #logo svg {
      display: block;
      width: 160px;
      height: 29px;
      max-width: 90vw;
    }
    #findme-message {
      display: none;
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      background: rgba(255,255,255,0.92);
      color: #d62525;
      font-size: 17px;
      font-family: Arial, Helvetica, sans-serif;
      font-weight: bold;
      text-align: center;
      opacity: 0;
      padding: 7px 20px;
      border-radius: 16px;
      box-shadow: 0 2px 8px #0001;
      transition: opacity 0.4s;
      pointer-events: none;
    }
    #date-btn {
      margin-right: 7px;
      padding: 0;
      border: none;
      background: none;
      outline: none;
      font-family: Arial, Helvetica, sans-serif;
      cursor: pointer;
    }
    .hide-date-btn { display: none !important; }
    #date-btn-inner {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.85);
      border: 1.5px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      color: #222;
      cursor: pointer;
      font-family: Arial, Helvetica, sans-serif;
    }
    #date-btn-inner:active,
    #date-btn-inner:focus,
    #date-btn-inner:hover {
      background: #f8f8f8;
      border-color: #999;
    }
    #date-btn-inner img {
      width: 22px;
      height: 22px;
    }
    #date-popup {
      display: none;
      opacity: 0;
      position: absolute;
      right: 0;
      top: 48px;
      min-width: 180px;
      max-height: 70vh;
      overflow-y: auto;
      background: rgba(255,255,255,0.96);
      border: 1.5px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 3px 15px #0002;
      z-index: 1400;
      font-family: Arial, Helvetica, sans-serif;
    }
    .date-popup-item {
      display: block;
      width: 100%;
      border: none;
      background: none;
      font-size: 15px;
      text-align: left;
      padding: 9px 16px;
      cursor: pointer;
      font-family: Arial, Helvetica, sans-serif;
    }
    .date-popup-item.selected {
      background: #f2f5fa;
      color: #3761c4;
      font-weight: bold;
    }
    .date-popup-item:active, .date-popup-item:hover {
      background: #f8f8f8;
    }
    #current-date-display {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1500;
      background: none;
      color: #fff;
      font-size: 22px;
      font-family: Arial, Helvetica, sans-serif;
      font-weight: bold;
      text-shadow: 0 3px 16px #222, 0 1px 0 #222;
      pointer-events: none;
      opacity: 0.97;
      padding: 0 22px;
    }
    #quick-switch-btn {
      position: absolute;
      bottom: 18px;
      right: 16px;
      z-index: 1300;
      display: none;
      font-family: Arial, Helvetica, sans-serif;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(255,255,255,0.90);
      border: 1.5px solid #ccc;
      box-shadow: 0 3px 15px #0002;
      justify-content: center;
      align-items: center;
      color: #23287b;
      padding: 0;
      cursor: pointer;
    }
    #quick-switch-btn:active,
    #quick-switch-btn:focus,
    #quick-switch-btn:hover {
      background: #f8f8f8;
      border-color: #999;
    }
    #quick-switch-btn img {
      width: 24px;
      height: 24px;
    }
    @media (max-width: 600px) {
      .control-row { right: 4px; top: 4px; }
      #date-btn { margin-right: 0; }
      #roads-btn { top: 48px; }
      #findme-btn { top: 88px; }
      .ol-control-inner, #date-btn-inner, #quick-switch-btn {
        width: 32px; height: 32px; border-radius: 6px; font-size: 13px;
      }
      .ol-control-inner img,
      #date-btn-inner img,
      #quick-switch-btn img { width: 18px; height: 18px; }
      #logo { left: 50%; transform: translateX(-50%); bottom: 8px;}
      #logo svg { width: 105px !important; height: 19px !important; }
      #current-date-display { font-size: 16px; padding: 0 10px; top: 10px; }
      #quick-switch-btn { bottom: 8px; right: 8px; }
      #date-popup { min-width: 140px; max-height: 50vh; top: 40px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="control-row">
    <button id="date-btn" type="button">
      <span id="date-btn-inner" class="ol-control-inner">
        <img src="icons/calendar.svg" alt="Date Selector">
      </span>
    </button>
    <div id="date-popup"></div>
    <button id="toggle-btn" class="ol-control custom-btn">
      <span class="ol-control-inner" id="toggle-icon">
        <img src="icons/satellite.svg" alt="Satellite">
      </span>
    </button>
  </div>
  <button id="roads-btn" class="ol-control custom-btn">
    <span class="ol-control-inner" id="roads-icon">
      <img src="icons/roads.svg" alt="Roads">
    </span>
  </button>
  <button id="findme-btn" class="ol-control custom-btn">
    <span class="ol-control-inner" id="findme-icon">
      <img src="icons/locateme.svg" alt="Locate Me">
    </span>
  </button>
  <div id="findme-message"></div>
  <button id="quick-switch-btn" title="Quick Switch Dates" class="ol-control-inner">
    <img src="icons/switch.svg" alt="Switch">
  </button>
  <div id="logo">
    <svg width="160" height="29" viewBox="0 0 350 60"><defs><filter id="floatingShadow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="3" stdDeviation="5" flood-color="#000" flood-opacity="0.22"/></filter></defs><g filter="url(#floatingShadow)"><g><rect x="26" y="25" width="8" height="15" fill="#4461a9"/><rect x="31" y="17" width="6" height="23" fill="#577cd7"/><polygon points="34,9 29,25 39,25" fill="#4461a9"/><rect x="39" y="28" width="6" height="10" fill="#89aef4"/><polygon points="42,21 39,28 45,28" fill="#577cd7"/><rect x="22" y="32" width="4" height="7" fill="#89aef4"/><polygon points="24,28 22,32 26,32" fill="#577cd7"/></g><g><path d="M 10 40 Q 28 10 54 16 Q 60 18 68 35" fill="none" stroke="#ffd700" stroke-width="1.5" stroke-dasharray="4,3"/><circle cx="15" cy="35" r="1.1" fill="#ffd700"/><polygon points="19,28 19.7,29.3 21,29.6 19.7,30 19,31.3 18.3,30 17,29.6 18.3,29.3" fill="#fff"/><circle cx="26" cy="22" r="1.3" fill="#ffd700"/><polygon points="32,15 32.7,16.3 34,16.6 32.7,17 32,18.3 31.3,17 30,16.6 31.3,16.3" fill="#fff"/><circle cx="43" cy="17" r="1.1" fill="#ffd700"/><polygon points="50,18 50.7,19.3 52,19.6 50.7,20 50,21.3 49.3,20 48,19.6 49.3,19.3" fill="#fff"/><circle cx="56" cy="19" r="1.2" fill="#ffd700"/><polygon points="65,29 65.7,30.3 67,30.6 65.7,31 65,32.3 64.3,31 63,30.6 64.3,30.3" fill="#fff"/></g><text x="70" y="40" font-family="Arial, Helvetica, sans-serif" font-size="23" fill="#23287b" letter-spacing="0" style="text-shadow: 0 2px 6px #fff, 0 1px 0 #ccc;">WDW Magic Explorer</text></g></svg>
  </div>
  <div id="current-date-display"></div>
  <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
  <script>
    // Load serverOptions from external servers.json before running app logic
    fetch('servers.json')
      .then(res => res.json())
      .then(serverOptions => {
        function getLabelForCode(code) {
          let found = serverOptions.find(opt => opt.code === code);
          return found ? found.label : '';
        }

        // Disney bounding box
        var disneyWorldExtent = ol.proj.transformExtent(
          [-81.9200, 28.1772, -81.2244, 28.6390],
          'EPSG:4326', 'EPSG:3857'
        );

        // Initial Disney Map Server (most recent)
        var disneyServer = serverOptions[serverOptions.length - 1].code;

        function makeDisneyLayer(server) {
          return new ol.layer.Tile({
            source: new ol.source.XYZ({
              url: `https://cdn6.parksmedia.wdprapps.disney.com/media/maps/prod/${server}/{z}/{x}/{y}.jpg`,
              minZoom: 0, maxZoom: 20
            }),
            visible: true
          });
        }

        var disneyLayer = makeDisneyLayer(disneyServer);

        var googleLayer = new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
            minZoom: 0, maxZoom: 20
          }),
          visible: false
        });

        var googleRoadsLayer = new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: 'https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}',
            minZoom: 0, maxZoom: 20
          }),
          visible: false, opacity: 0.85
        });

        disneyLayer.getSource().set('extent', disneyWorldExtent);
        googleLayer.getSource().set('extent', disneyWorldExtent);
        googleRoadsLayer.getSource().set('extent', disneyWorldExtent);

        var map = new ol.Map({
          target: 'map',
          layers: [disneyLayer, googleLayer, googleRoadsLayer],
          view: new ol.View({
            center: ol.proj.fromLonLat([-81.5494, 28.3747]),
            zoom: 16,
            minZoom: 0, maxZoom: 20,
            extent: disneyWorldExtent
          })
        });

        // Date selector popup logic
        var dateBtn = document.getElementById('date-btn');
        var dateBtnInner = document.getElementById('date-btn-inner');
        var datePopup = document.getElementById('date-popup');
        var currentDateDisplay = document.getElementById('current-date-display');
        var quickSwitchBtn = document.getElementById('quick-switch-btn');

        // Tracks last two unique Disney map date codes (most recent at index 0)
        var lastTwoDates = [disneyServer, null];

        function fillDatePopup(selectedCode) {
          datePopup.innerHTML = '';
          serverOptions.slice().reverse().forEach(opt => {
            var btn = document.createElement('button');
            btn.className = 'date-popup-item' + (opt.code === selectedCode ? ' selected' : '');
            btn.textContent = opt.label;
            btn.onclick = function() {
              setDisneyDate(opt.code);
              hideDatePopup();
            };
            datePopup.appendChild(btn);
          });
        }
        function showDatePopup() {
          fillDatePopup(disneyServer);
          datePopup.style.display = 'block';
          setTimeout(() => { datePopup.style.opacity = '1'; }, 10);
          setTimeout(() => {
            document.addEventListener('mousedown', hideOnOutside, { once: true });
            document.addEventListener('touchstart', hideOnOutside, { once: true });
          }, 0);
        }
        function hideOnOutside(e) {
          if (!datePopup.contains(e.target) && !dateBtn.contains(e.target)) hideDatePopup();
        }
        function hideDatePopup() {
          datePopup.style.opacity = '0';
          setTimeout(() => { datePopup.style.display = 'none'; }, 180);
        }
        dateBtn.onclick = function() {
          if (datePopup.style.display === 'block') {
            hideDatePopup();
          } else {
            showDatePopup();
          }
        };

        function setDisneyDate(newCode) {
          if (disneyServer === newCode) return;
          if (lastTwoDates[0] !== newCode) {
            lastTwoDates = [newCode, lastTwoDates[0]];
          }
          disneyServer = newCode;
          var vis = disneyLayer.getVisible();
          map.removeLayer(disneyLayer);
          disneyLayer = makeDisneyLayer(newCode);
          disneyLayer.setVisible(vis);
          disneyLayer.getSource().set('extent', disneyWorldExtent);
          map.getLayers().insertAt(0, disneyLayer);
          updateDateUI();
        }

        function updateDateUI() {
          var isDisney = showingDisney;
          dateBtn.style.display = isDisney ? 'inline-flex' : 'none';
          datePopup.style.display = 'none';
          quickSwitchBtn.style.display = (isDisney && lastTwoDates[1]) ? 'flex' : 'none';
          if (isDisney) {
            currentDateDisplay.textContent = getLabelForCode(disneyServer);
            currentDateDisplay.style.display = 'block';
          } else {
            currentDateDisplay.textContent = '';
            currentDateDisplay.style.display = 'none';
          }
        }

        var showingDisney = true;
        document.getElementById('toggle-btn').onclick = function() {
          showingDisney = !showingDisney;
          disneyLayer.setVisible(showingDisney);
          googleLayer.setVisible(!showingDisney);
          updateDateUI();
          document.getElementById('toggle-icon').querySelector('img').src =
            showingDisney ? 'icons/satellite.svg' : 'icons/mouse.svg';
          document.getElementById('toggle-icon').querySelector('img').alt =
            showingDisney ? 'Satellite' : 'Disney Map';
        };

        quickSwitchBtn.onclick = function() {
          if (lastTwoDates[1]) {
            setDisneyDate(lastTwoDates[1]);
          }
        };

        var roadsOn = false;
        document.getElementById('roads-btn').onclick = function() {
          roadsOn = !roadsOn;
          document.getElementById('roads-icon').querySelector('img').src =
            roadsOn ? 'icons/no_roads.svg' : 'icons/roads.svg';
          document.getElementById('roads-icon').querySelector('img').alt =
            roadsOn ? 'No Roads' : 'Roads';
          googleRoadsLayer.setVisible(roadsOn);
        };

        var findmeBtn = document.getElementById('findme-btn');
        var findmeMessage = document.getElementById('findme-message');
        var userLocationLayer = null;

        findmeBtn.onclick = function() {
          if (!navigator.geolocation) { showFindMeMessage('Geolocation not supported'); return; }
          navigator.geolocation.getCurrentPosition(function(pos) {
            var coords = [pos.coords.longitude, pos.coords.latitude];
            var projected = ol.proj.fromLonLat(coords);
            var within = ol.extent.containsCoordinate(disneyWorldExtent, projected);
            if (!within) { showFindMeMessage('Outside of WDW'); removeUserLocation(); return; }
            removeUserLocation();
            userLocationLayer = new ol.layer.Vector({
              source: new ol.source.Vector({
                features: [new ol.Feature({geometry: new ol.geom.Point(projected)})]
              }),
              style: new ol.style.Style({
                image: new ol.style.Circle({
                  radius: 10, fill: new ol.style.Fill({color: 'rgba(0,116,217,0.35)'}),
                  stroke: new ol.style.Stroke({color: '#0074d9', width: 3})
                })
              }),
              zIndex: 99
            });
            map.addLayer(userLocationLayer);
            map.getView().animate({center: projected, zoom: 17, duration: 800});
          }, function(error) {
            showFindMeMessage('Unable to get location');
          }, { enableHighAccuracy: true });
        };

        function showFindMeMessage(msg) {
          findmeMessage.textContent = msg;
          findmeMessage.style.display = 'block';
          setTimeout(function() { findmeMessage.style.opacity = '1'; }, 10);
          setTimeout(function() {
            findmeMessage.style.opacity = '0';
            setTimeout(function() { findmeMessage.style.display = 'none'; }, 400);
          }, 2200);
        }
        function removeUserLocation() {
          if (userLocationLayer) {
            map.removeLayer(userLocationLayer);
            userLocationLayer = null;
          }
        }

        (function() {
          var lastTap = 0;
          var isHoldZoom = false;
          var startY = 0;
          var startZoom = 0;
          var mapDiv = document.getElementById('map');
          var holdTimeout = null;

          mapDiv.addEventListener('touchstart', function(e) {
            if (e.touches.length !== 1) return;
            var now = Date.now();
            if (now - lastTap < 350) {
              e.preventDefault();
              startY = e.touches[0].clientY;
              startZoom = map.getView().getZoom();
              isHoldZoom = true;
              holdTimeout = setTimeout(function() {
                mapDiv.addEventListener('touchmove', moveHandler, { passive: false });
              }, 100);
            } else {
              lastTap = now;
              isHoldZoom = false;
              if (holdTimeout) clearTimeout(holdTimeout);
            }
          });
          mapDiv.addEventListener('touchend', function(e) {
            if (isHoldZoom) {
              isHoldZoom = false;
              mapDiv.removeEventListener('touchmove', moveHandler, { passive: false });
            }
            if (holdTimeout) clearTimeout(holdTimeout);
          });
          function moveHandler(e) {
            if (!isHoldZoom || e.touches.length !== 1) return;
            e.preventDefault();
            var dy = e.touches[0].clientY - startY;
            var newZoom = startZoom - dy / 80;
            var view = map.getView();
            newZoom = Math.max(view.getMinZoom(), Math.min(view.getMaxZoom(), newZoom));
            view.setZoom(newZoom);
          }
        })();

        updateDateUI();
      });
  </script>
</body>
</html>
