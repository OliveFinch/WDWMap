<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Magic Parks Explorer – Admin</title>
  <style>
    html, body { margin:0; padding:0; font-family: Arial, Helvetica, sans-serif; background:#f6f7fb; color:#111; }
    header { position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7ef; padding:12px 16px; z-index:10; }
    header h1 { margin:0; font-size:16px; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 14px 16px 40px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    label { font-size:12px; color:#444; display:block; margin-bottom:6px; }
    input, select, textarea { font: inherit; padding:10px; border:1px solid #cfd5e2; border-radius:10px; background:#fff; }
    input[type="password"], input[type="text"] { min-width: 320px; }
    select { min-width: 220px; }
    button { font: inherit; padding:10px 12px; border-radius:10px; border:1px solid #cfd5e2; background:#fff; cursor:pointer; }
    button.primary { background:#3761c4; color:#fff; border-color:#3761c4; }
    button.danger { background:#b00020; color:#fff; border-color:#b00020; }
    button:disabled { opacity:.6; cursor:default; }
    .card { background:#fff; border:1px solid #e5e7ef; border-radius:14px; box-shadow: 0 1px 10px rgba(0,0,0,0.04); padding:12px; margin-top:12px; }
    .meta { font-size:12px; color:#555; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 14px; }
    .item { background:#fff; border:1px solid #e5e7ef; border-radius:14px; padding:12px; }
    .item h3 { margin:0 0 6px 0; font-size:14px; }
    .item p { margin:8px 0 0 0; line-height:1.35; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .small { font-size:12px; color:#666; }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#2b46a4; border:1px solid #d9e1ff; }
    .status { margin-left:8px; }
    .error { color:#b00020; white-space:pre-wrap; }
    .ok { color:#1b5e20; white-space:pre-wrap; }
    textarea { width: 100%; min-height: 90px; }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px; }
    .inline { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .field { display:flex; flex-direction:column; min-width: 220px; }
    .muted { opacity: .8; }
    .editbox { margin-top:10px; padding-top:10px; border-top:1px dashed #e5e7ef; }
    .editbox summary { cursor:pointer; font-weight:700; }
    .hint { font-size:12px; color:#666; line-height:1.35; margin-top:6px; }
    @media (max-width: 800px) {
      .two { grid-template-columns: 1fr; }
      input[type="password"], input[type="text"] { min-width: 240px; width: 100%; }
      select { width: 100%; }
      .field { min-width: 0; width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Magic Parks Explorer – Admin Console</h1>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div class="field">
          <label for="workerOrigin">Worker origin</label>
          <input id="workerOrigin" type="text" value="https://wdw-magic-explorer-api.gullet-erase2v.workers.dev" />
        </div>

        <div class="field">
          <label for="adminToken">Admin token (Bearer)</label>
          <input id="adminToken" type="password" placeholder="Paste your ADMIN_TOKEN" />
          <div class="small muted">Stored locally in your browser when you click Save.</div>
        </div>

        <div class="field">
          <label for="status">Status</label>
          <select id="status">
            <option value="pending" selected>pending</option>
            <option value="approved">approved</option>
            <option value="rejected">rejected</option>
          </select>
        </div>

        <div class="field">
          <label for="parkFilter">Park</label>
          <select id="parkFilter">
            <option value="">All parks</option>
            <option value="wdw">Walt Disney World</option>
            <option value="dlr">Disneyland</option>
            <option value="dlp">Disneyland Paris</option>
            <option value="hkdl">Hong Kong Disneyland</option>
            <option value="shdr">Shanghai Disneyland</option>
          </select>
        </div>

        <div class="inline">
          <button id="saveBtn">Save</button>
          <button id="refreshBtn" class="primary">Refresh</button>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div id="msg" class="small"></div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <span class="pill">Reports</span>
          <span id="count" class="meta status"></span>
        </div>
        <div class="small">Tip: open DevTools → Network to see the admin API calls.</div>
      </div>

      <div id="list" class="grid"></div>
    </div>
  </div>

  <script>
    (function () {
      'use strict';

      const els = {
        workerOrigin: document.getElementById('workerOrigin'),
        adminToken: document.getElementById('adminToken'),
        status: document.getElementById('status'),
        parkFilter: document.getElementById('parkFilter'),
        saveBtn: document.getElementById('saveBtn'),
        refreshBtn: document.getElementById('refreshBtn'),
        list: document.getElementById('list'),
        msg: document.getElementById('msg'),
        count: document.getElementById('count'),
      };

      const PARK_NAMES = {
        wdw: 'Walt Disney World',
        dlr: 'Disneyland',
        dlp: 'Disneyland Paris',
        hkdl: 'Hong Kong Disneyland',
        shdr: 'Shanghai Disneyland'
      };

      const LS_ORIGIN = 'wdwmx_admin_origin';
      const LS_TOKEN  = 'wdwmx_admin_token';

      function setMsg(text, kind) {
        els.msg.className = kind === 'error' ? 'error' : (kind === 'ok' ? 'ok' : 'small');
        els.msg.textContent = text || '';
      }

      function getHeaders() {
        const token = (els.adminToken.value || '').trim();
        return {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        };
      }

      function safe(v, fallback='') {
        if (v === null || v === undefined) return fallback;
        return String(v);
      }

      function numOrEmpty(v) {
        if (v === null || v === undefined || v === '') return '';
        const n = Number(v);
        return Number.isFinite(n) ? String(n) : '';
      }

      function fmtWhen(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return safe(iso);
        return d.toLocaleString(undefined, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      }

      async function fetchWithDetail(url, opts) {
        const res = await fetch(url, opts);
        const text = await res.text();
        let json = null;
        try { json = JSON.parse(text); } catch {}
        return { res, text, json };
      }

      async function api(path, opts) {
        const origin = (els.workerOrigin.value || '').replace(/\/$/, '');
        const url = origin + path;

        const { res, text, json } = await fetchWithDetail(url, opts);

        if (!res.ok) {
          const detail = json ? JSON.stringify(json) : text;
          throw new Error(res.status + ' ' + res.statusText + (detail ? ' — ' + detail : ''));
        }

        return json ?? text;
      }

      function normalizeList(data) {
        if (Array.isArray(data)) return data;
        if (data && Array.isArray(data.results)) return data.results;
        if (data && Array.isArray(data.items)) return data.items;
        return [];
      }

      // Convert empty string -> null (so you can clear displayName)
      function emptyToNull(s) {
        const t = safe(s, '').trim();
        return t === '' ? null : t;
      }

      async function saveEdits(id, fields) {
        // IMPORTANT: Worker expects camelCase keys (serverId/mapVersion/displayName/adminNotes)
        const body = {};

        if (fields.description !== undefined) body.description = safe(fields.description).trim();
        if (fields.category !== undefined) body.category = safe(fields.category).trim();
        if (fields.parkId !== undefined) body.parkId = safe(fields.parkId).trim();

        if (fields.displayName !== undefined) body.displayName = emptyToNull(fields.displayName);
        if (fields.serverId !== undefined) body.serverId = safe(fields.serverId).trim();
        if (fields.mapVersion !== undefined) body.mapVersion = safe(fields.mapVersion).trim();
        if (fields.adminNotes !== undefined) body.adminNotes = emptyToNull(fields.adminNotes);

        if (fields.lat !== undefined) body.lat = fields.lat;
        if (fields.lng !== undefined) body.lng = fields.lng;
        if (fields.zoom !== undefined) body.zoom = fields.zoom;

        // Remove undefined (safety)
        Object.keys(body).forEach((k) => body[k] === undefined && delete body[k]);

        if (!Object.keys(body).length) {
          setMsg('Nothing to save (no edits entered).', 'error');
          return;
        }

        const origin = (els.workerOrigin.value || '').replace(/\/$/, '');
        const url = origin + '/api/admin/reports/' + encodeURIComponent(id);

        const { res, text, json } = await fetchWithDetail(url, {
          method: 'PATCH',
          headers: getHeaders(),
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const detail = json ? JSON.stringify(json) : text;
          throw new Error(res.status + ' ' + res.statusText + (detail ? ' — ' + detail : ''));
        }

        return (json ?? text);
      }

      function makeCategorySelect(current) {
        const sel = document.createElement('select');
        const cur = (safe(current).trim().toLowerCase() || 'other');
        const norm = (cur === 'general') ? 'other' : cur;

        const opts = [
          ['new', 'New (ride, road, building)'],
          ['changed', 'Changed (layout, entrance, path)'],
          ['removed', 'Removed (closed, demolished)'],
          ['other', 'Other']
        ];

        for (const [val, label] of opts) {
          const o = document.createElement('option');
          o.value = val;
          o.textContent = label;
          if (val === norm) o.selected = true;
          sel.appendChild(o);
        }
        return sel;
      }

      async function load() {
        els.refreshBtn.disabled = true;
        els.list.innerHTML = '';
        els.count.textContent = '';
        setMsg('Loading…');

        try {
          const status = els.status.value;
          const parkId = els.parkFilter.value;
          let apiUrl = '/api/admin/reports?status=' + encodeURIComponent(status);
          if (parkId) apiUrl += '&parkId=' + encodeURIComponent(parkId);
          const data = await api(apiUrl, {
            method: 'GET',
            headers: getHeaders()
          });

          const items = normalizeList(data);
          els.count.textContent = items.length ? (items.length + ' item(s)') : 'No items';
          setMsg('', '');

          if (!items.length) {
            els.list.innerHTML = '<div class="small">Nothing to show.</div>';
            return;
          }

          for (const it of items) {
            const div = document.createElement('div');
            div.className = 'item';

            const parkId = safe(it.park_id, 'wdw');
            const parkName = PARK_NAMES[parkId] || parkId;

            const title = document.createElement('h3');
            title.textContent = parkName + ' — ' + (safe(it.map_version) || safe(it.server_id) || 'Report');
            div.appendChild(title);

            const idLine = document.createElement('div');
            idLine.className = 'small';
            idLine.textContent = 'ID: ' + safe(it.id);
            div.appendChild(idLine);

            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent =
              'Status: ' + safe(it.status) +
              ' | Park: ' + parkId +
              ' | Created: ' + (fmtWhen(it.created_at) || '') +
              (it.approved_at ? (' | Approved: ' + fmtWhen(it.approved_at)) : '') +
              (it.updated_at ? (' | Updated: ' + fmtWhen(it.updated_at)) : '');
            div.appendChild(meta);

            const coords = document.createElement('div');
            coords.className = 'small';
            coords.textContent =
              'lat=' + safe(it.lat) + ', lng=' + safe(it.lng) + ', zoom=' + safe(it.zoom) +
              (it.map_version ? ' | map_version=' + safe(it.map_version) : '') +
              (it.server_id ? ' | server_id=' + safe(it.server_id) : '') +
              (it.category ? ' | category=' + safe(it.category) : '') +
              (it.display_name ? ' | display_name=' + safe(it.display_name) : '');
            div.appendChild(coords);

            const desc = document.createElement('p');
            desc.textContent = safe(it.description);
            div.appendChild(desc);

            // ------- Edit box -------
            const details = document.createElement('details');
            details.className = 'editbox';

            const sum = document.createElement('summary');
            sum.textContent = 'Edit report before approving';
            details.appendChild(sum);

            const hint = document.createElement('div');
            hint.className = 'hint';
            hint.textContent = 'Edits save via PATCH /api/admin/reports/:id. Field names must be camelCase for the Worker (displayName, serverId, mapVersion).';
            details.appendChild(hint);

            const two = document.createElement('div');
            two.className = 'two';

            const colA = document.createElement('div');

            const fDescLabel = document.createElement('label');
            fDescLabel.textContent = 'Description';
            const fDesc = document.createElement('textarea');
            fDesc.value = safe(it.description);
            colA.appendChild(fDescLabel);
            colA.appendChild(fDesc);

            const fCategoryLabel = document.createElement('label');
            fCategoryLabel.style.marginTop = '10px';
            fCategoryLabel.textContent = 'Type';
            const fCategory = makeCategorySelect(it.category);
            colA.appendChild(fCategoryLabel);
            colA.appendChild(fCategory);

            const fDisplayLabel = document.createElement('label');
            fDisplayLabel.style.marginTop = '10px';
            fDisplayLabel.textContent = 'Display name (optional)';
            const fDisplay = document.createElement('input');
            fDisplay.type = 'text';
            fDisplay.value = safe(it.display_name);
            colA.appendChild(fDisplayLabel);
            colA.appendChild(fDisplay);

            const colB = document.createElement('div');

            const fLatLabel = document.createElement('label');
            fLatLabel.textContent = 'Lat';
            const fLat = document.createElement('input');
            fLat.type = 'text';
            fLat.inputMode = 'decimal';
            fLat.value = numOrEmpty(it.lat);
            colB.appendChild(fLatLabel);
            colB.appendChild(fLat);

            const fLngLabel = document.createElement('label');
            fLngLabel.style.marginTop = '10px';
            fLngLabel.textContent = 'Lng';
            const fLng = document.createElement('input');
            fLng.type = 'text';
            fLng.inputMode = 'decimal';
            fLng.value = numOrEmpty(it.lng);
            colB.appendChild(fLngLabel);
            colB.appendChild(fLng);

            const fZoomLabel = document.createElement('label');
            fZoomLabel.style.marginTop = '10px';
            fZoomLabel.textContent = 'Zoom';
            const fZoom = document.createElement('input');
            fZoom.type = 'text';
            fZoom.inputMode = 'decimal';
            fZoom.value = numOrEmpty(it.zoom);
            colB.appendChild(fZoomLabel);
            colB.appendChild(fZoom);

            const fMapVerLabel = document.createElement('label');
            fMapVerLabel.style.marginTop = '10px';
            fMapVerLabel.textContent = 'mapVersion';
            const fMapVer = document.createElement('input');
            fMapVer.type = 'text';
            fMapVer.value = safe(it.map_version);
            colB.appendChild(fMapVerLabel);
            colB.appendChild(fMapVer);

            const fServerIdLabel = document.createElement('label');
            fServerIdLabel.style.marginTop = '10px';
            fServerIdLabel.textContent = 'serverId';
            const fServerId = document.createElement('input');
            fServerId.type = 'text';
            fServerId.value = safe(it.server_id);
            colB.appendChild(fServerIdLabel);
            colB.appendChild(fServerId);

            const fParkIdLabel = document.createElement('label');
            fParkIdLabel.style.marginTop = '10px';
            fParkIdLabel.textContent = 'parkId';
            const fParkId = document.createElement('select');
            ['wdw', 'dlr', 'dlp', 'hkdl', 'shdr'].forEach(p => {
              const o = document.createElement('option');
              o.value = p;
              o.textContent = PARK_NAMES[p] || p;
              if (p === parkId) o.selected = true;
              fParkId.appendChild(o);
            });
            colB.appendChild(fParkIdLabel);
            colB.appendChild(fParkId);

            two.appendChild(colA);
            two.appendChild(colB);
            details.appendChild(two);

            const editActions = document.createElement('div');
            editActions.className = 'actions';

            const saveEditsBtn = document.createElement('button');
            saveEditsBtn.textContent = 'Save edits';
            saveEditsBtn.className = 'primary';

            const resetBtn = document.createElement('button');
            resetBtn.textContent = 'Reset fields';

            saveEditsBtn.addEventListener('click', async () => {
              saveEditsBtn.disabled = true;
              setMsg('Saving edits for ' + it.id + '…');

              try {
                const lat = fLat.value.trim() === '' ? undefined : Number(fLat.value);
                const lng = fLng.value.trim() === '' ? undefined : Number(fLng.value);
                const zoom = fZoom.value.trim() === '' ? undefined : Number(fZoom.value);

                if (lat !== undefined && !Number.isFinite(lat)) throw new Error('Lat must be a number');
                if (lng !== undefined && !Number.isFinite(lng)) throw new Error('Lng must be a number');
                if (zoom !== undefined && !Number.isFinite(zoom)) throw new Error('Zoom must be a number');

                await saveEdits(it.id, {
                  description: fDesc.value,
                  category: fCategory.value,
                  displayName: fDisplay.value,
                  lat: lat,
                  lng: lng,
                  zoom: zoom,
                  mapVersion: fMapVer.value,
                  serverId: fServerId.value,
                  parkId: fParkId.value
                });

                setMsg('Saved edits for ' + it.id, 'ok');
                await load();
              } catch (e) {
                setMsg('Save edits failed: ' + e.message, 'error');
              } finally {
                saveEditsBtn.disabled = false;
              }
            });

            resetBtn.addEventListener('click', () => {
              fDesc.value = safe(it.description);
              // category: reset select by recreating it
              const newSel = makeCategorySelect(it.category);
              fCategory.replaceWith(newSel);

              // update reference for save handler: simplest is refresh the whole page state:
              // so just instruct user to hit Save after changing; but we can keep it working by reloading
              // We'll just reload to keep it clean.
              setMsg('Reset fields for ' + it.id + ' (reloading list)…', 'ok');
              load();

              fDisplay.value = safe(it.display_name);
              fLat.value = numOrEmpty(it.lat);
              fLng.value = numOrEmpty(it.lng);
              fZoom.value = numOrEmpty(it.zoom);
              fMapVer.value = safe(it.map_version);
              fServerId.value = safe(it.server_id);
              fParkId.value = parkId;
            });

            editActions.appendChild(saveEditsBtn);
            editActions.appendChild(resetBtn);
            details.appendChild(editActions);

            div.appendChild(details);

            // ------- Approve/Reject actions -------
            const actions = document.createElement('div');
            actions.className = 'actions';

            const approveBtn = document.createElement('button');
            approveBtn.className = 'primary';
            approveBtn.textContent = 'Approve';
            approveBtn.disabled = (els.status.value === 'approved');

            const rejectBtn = document.createElement('button');
            rejectBtn.className = 'danger';
            rejectBtn.textContent = 'Reject';
            rejectBtn.disabled = (els.status.value === 'rejected');

            const reason = document.createElement('textarea');
            reason.placeholder = 'Rejection reason (optional, saved to admin_notes)';
            reason.style.display = 'none';

            const toggleReason = document.createElement('button');
            toggleReason.textContent = 'Add rejection note';
            toggleReason.disabled = (els.status.value === 'rejected');
            toggleReason.addEventListener('click', () => {
              reason.style.display = (reason.style.display === 'none') ? 'block' : 'none';
            });

            approveBtn.addEventListener('click', async () => {
              approveBtn.disabled = true;
              rejectBtn.disabled = true;
              setMsg('Approving ' + it.id + '…');
              try {
                await api('/api/admin/reports/' + encodeURIComponent(it.id) + '/approve', {
                  method: 'POST',
                  headers: getHeaders()
                });
                setMsg('Approved ' + it.id, 'ok');
                await load();
              } catch (e) {
                setMsg('Approve failed: ' + e.message, 'error');
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
              }
            });

            rejectBtn.addEventListener('click', async () => {
              rejectBtn.disabled = true;
              approveBtn.disabled = true;
              setMsg('Rejecting ' + it.id + '…');
              try {
                await api('/api/admin/reports/' + encodeURIComponent(it.id) + '/reject', {
                  method: 'POST',
                  headers: getHeaders(),
                  body: JSON.stringify({ reason: reason.value || '' })
                });
                setMsg('Rejected ' + it.id, 'ok');
                await load();
              } catch (e) {
                setMsg('Reject failed: ' + e.message, 'error');
                rejectBtn.disabled = false;
                approveBtn.disabled = false;
              }
            });

            actions.appendChild(approveBtn);
            actions.appendChild(rejectBtn);
            actions.appendChild(toggleReason);
            div.appendChild(actions);
            div.appendChild(reason);

            els.list.appendChild(div);
          }
        } catch (e) {
          setMsg('Load failed: ' + e.message, 'error');
        } finally {
          els.refreshBtn.disabled = false;
        }
      }

      // Restore saved settings
      const savedOrigin = localStorage.getItem(LS_ORIGIN);
      const savedToken  = localStorage.getItem(LS_TOKEN);
      if (savedOrigin) els.workerOrigin.value = savedOrigin;
      if (savedToken) els.adminToken.value = savedToken;

      els.saveBtn.addEventListener('click', () => {
        localStorage.setItem(LS_ORIGIN, (els.workerOrigin.value || '').trim());
        localStorage.setItem(LS_TOKEN, (els.adminToken.value || '').trim());
        setMsg('Saved.', 'ok');
      });

      els.refreshBtn.addEventListener('click', load);
      els.status.addEventListener('change', load);
      els.parkFilter.addEventListener('change', load);

      load();
    })();
  </script>
</body>
</html>
